# 🔄 重启服务指南

## 📋 操作步骤

### 步骤 1: 停止当前服务

在运行后端服务的终端窗口中：

**Windows**:
```
按 Ctrl + C
```

**Mac/Linux**:
```
按 Ctrl + C
```

等待看到服务停止的消息。

---

### 步骤 2: 重新启动服务

在同一个终端窗口中，运行：

```bash
npm run dev
```

---

### 步骤 3: 等待服务启动

您应该看到以下输出：

```
✅ 已从 llm.json 载入大模型配置
🚀 后端服务已启动: http://localhost:3002
👉 分析接口地址: http://localhost:3002/api/analyze-exam
👉 练习生成接口: http://localhost:3002/api/generate-practice
👉 Web 已托管: http://localhost:3002/
```

**如果看到这些消息，说明服务启动成功！** ✅

---

### 步骤 4: 打开前端

在浏览器中访问：

```
http://localhost:3002
```

---

### 步骤 5: 重新分析图片

1. **上传相同的 4 张图片**（或您之前测试的图片）
2. **点击"开始分析"**
3. **观察后端终端的日志输出**

---

## 🔍 关键日志检查

### 重点关注这一行：

```
✅ [Relevance Validator] 整体相关性: XX%
```

**预期变化**:
- **修复前**: 0%
- **修复后**: 50-80%

### 其他重要日志：

```
✅ [Relevance Validator] X/6 题目相关
```

**预期变化**:
- **修复前**: 0/6 题目相关
- **修复后**: 3-5/6 题目相关

---

## ✅ 成功标志

如果您看到以下内容，说明修复成功：

### 1. 无错误日志
- ✅ 没有 "仍包含 LaTeX 公式代码"
- ✅ 没有 "JSON 解析失败"
- ✅ 没有 "JSON 修复失败"

### 2. 相关性提升
- ✅ 整体相关性 > 50%
- ✅ 至少 3/6 题目相关

### 3. 质量评分
- ✅ 质量评分 > 60/100

---

## ⚠️ 故障排查

### 问题 1: 服务无法启动

**错误**: `Error: listen EADDRINUSE: address already in use :::3002`

**原因**: 端口 3002 已被占用

**解决方案**:
```bash
# Windows
netstat -ano | findstr :3002
taskkill /PID <进程ID> /F

# Mac/Linux
lsof -ti:3002 | xargs kill -9
```

然后重新运行 `npm run dev`

---

### 问题 2: 相关性仍然是 0%

**可能原因**:
1. 代码没有重新加载
2. 使用了缓存的结果

**解决方案**:
1. **确认代码已更新**: 检查 `backend/core/relevance-validator.ts` 文件
2. **清除缓存**: 在浏览器中按 `Ctrl + Shift + Delete` 清除缓存
3. **强制刷新**: 在浏览器中按 `Ctrl + F5` (Windows) 或 `Cmd + Shift + R` (Mac)

---

### 问题 3: 分析失败

**检查**:
1. LLM API Key 是否正确配置
2. 网络连接是否正常
3. 图片是否清晰可读

**查看日志**:
```
❌ [Job Failed] 任务执行失败
```

如果看到这个，请复制完整的错误堆栈并提供给我。

---

## 📊 对比测试

### 建议测试流程

1. **记录修复前的结果**:
   - 相关性: 0%
   - 相关题目: 0/6

2. **重启服务**

3. **重新分析相同图片**

4. **记录修复后的结果**:
   - 相关性: ____%
   - 相关题目: ___/6

5. **对比改进**:
   - 相关性提升: ____% → ____%
   - 题目数量提升: 0/6 → ___/6

---

## 🎯 预期结果

### 修复前（您的日志）
```
✅ [Relevance Validator] 整体相关性: 0%
✅ [Relevance Validator] 0/6 题目相关
⚠️ [Relevance Validator] 练习题相关性不足，建议重新生成
⚠️ [Relevance Validator] 相关性得分: 0%
⚠️ [Relevance Validator] 题目 1 不相关 (得分: 0%):
⚠️ [Relevance Validator] 题目 2 不相关 (得分: 0%):
⚠️ [Relevance Validator] 题目 3 不相关 (得分: 0%):
⚠️ [Relevance Validator] 题目 4 不相关 (得分: 0%):
⚠️ [Relevance Validator] 题目 1 不相关 (得分: 0%):
⚠️ [Relevance Validator] 题目 2 不相关 (得分: 0%):
```

### 修复后（预期）
```
✅ [Relevance Validator] 整体相关性: 65%
✅ [Relevance Validator] 4/6 题目相关
✅ [Relevance Validator] 题目 1 相关 (得分: 70%): 知识点匹配度: 70%
✅ [Relevance Validator] 题目 2 相关 (得分: 60%): 知识点匹配度: 60%
⚠️ [Relevance Validator] 题目 3 不相关 (得分: 15%): 知识点匹配度: 15%
✅ [Relevance Validator] 题目 4 相关 (得分: 75%): 知识点匹配度: 75%
✅ [Relevance Validator] 题目 5 相关 (得分: 55%): 知识点匹配度: 55%
⚠️ [Relevance Validator] 题目 6 不相关 (得分: 10%): 知识点匹配度: 10%
```

---

## 💡 提示

### 如果相关性仍然较低（< 30%）

这可能意味着：
1. **练习题确实与试卷内容不太相关** - 这是 LLM 生成的问题，不是验证逻辑的问题
2. **知识点提取不准确** - 需要改进知识点提取逻辑
3. **验证算法仍需优化** - 可能需要更智能的匹配策略

在这种情况下，请提供：
- 试卷中的知识点列表
- 生成的练习题内容（前 2-3 题）
- 您认为它们是否相关

我会进一步优化算法。

---

## 📞 需要帮助？

如果遇到任何问题，请提供：
1. **完整的启动日志**（从 `npm run dev` 开始）
2. **完整的分析日志**（从开始分析到完成）
3. **浏览器控制台的错误**（按 F12 打开）
4. **您的操作步骤**

---

**准备好了吗？** 

现在请按照上面的步骤操作，完成后告诉我结果！🚀
