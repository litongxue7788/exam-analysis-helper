# Task 5.1 å®ŒæˆæŠ¥å‘Šï¼šæ”¹è¿›é”™è¯¯æ¶ˆæ¯

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡**: Task 5.1 - æ”¹è¿›é”™è¯¯æ¶ˆæ¯  
**ä¼˜å…ˆçº§**: P0ï¼ˆç´§æ€¥ä¿®å¤ï¼‰  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**å®Œæˆæ—¶é—´**: 2026-01-11

## ğŸ¯ ç›®æ ‡

æä¾›å‹å¥½ã€å…·ä½“ã€å¯æ“ä½œçš„é”™è¯¯æç¤ºï¼Œæ›¿ä»£æ³›æ³›çš„æŠ€æœ¯é”™è¯¯æ¶ˆæ¯ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç†è§£é—®é¢˜å¹¶æ‰¾åˆ°è§£å†³æ–¹æ¡ˆã€‚

## âœ… å®ç°å†…å®¹

### 1. åˆ›å»ºé”™è¯¯æ¶ˆæ¯ç®¡ç†å™¨

**æ–‡ä»¶**: `backend/core/error-message-manager.ts`

**æ ¸å¿ƒåŠŸèƒ½**:
- å®šä¹‰15+ç§å¸¸è§é”™è¯¯ç±»å‹
- ä¸ºæ¯ç§é”™è¯¯æä¾›ï¼š
  * ç”¨æˆ·å‹å¥½çš„é”™è¯¯æè¿°
  * æŠ€æœ¯ç»†èŠ‚ï¼ˆç”¨äºæ—¥å¿—ï¼‰
  * å…·ä½“çš„è§£å†³å»ºè®®ï¼ˆ3-5æ¡ï¼‰
  * æ ‡å‡†åŒ–çš„é”™è¯¯ä»£ç 

**æ”¯æŒçš„é”™è¯¯ç±»å‹**:

#### å›¾ç‰‡ç›¸å…³é”™è¯¯
- `IMAGE_UPLOAD_FAILED` - å›¾ç‰‡ä¸Šä¼ å¤±è´¥
- `IMAGE_TOO_LARGE` - å›¾ç‰‡æ–‡ä»¶è¿‡å¤§
- `IMAGE_FORMAT_INVALID` - ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
- `NO_IMAGES_PROVIDED` - æœªæä¾›å›¾ç‰‡

#### è¯†åˆ«ç›¸å…³é”™è¯¯
- `OCR_FAILED` - OCRè¯†åˆ«å¤±è´¥
- `LOW_CONFIDENCE` - è¯†åˆ«ç½®ä¿¡åº¦è¾ƒä½
- `EVIDENCE_INCOMPLETE` - è¯æ®ä¿¡æ¯ä¸å®Œæ•´

#### LLMç›¸å…³é”™è¯¯
- `LLM_TIMEOUT` - LLMè¯·æ±‚è¶…æ—¶
- `LLM_API_ERROR` - LLM APIé”™è¯¯
- `JSON_PARSE_FAILED` - JSONè§£æå¤±è´¥

#### é™åˆ¶ç›¸å…³é”™è¯¯
- `RATE_LIMIT_EXCEEDED` - è¯·æ±‚é¢‘ç‡è¶…é™
- `DAILY_QUOTA_EXCEEDED` - æ¯æ—¥é…é¢è¶…é™

#### é€šç”¨é”™è¯¯
- `INVALID_REQUEST` - æ— æ•ˆè¯·æ±‚
- `NETWORK_ERROR` - ç½‘ç»œè¿æ¥å¤±è´¥
- `SERVER_ERROR` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

### 2. é›†æˆåˆ°æ‰€æœ‰ä¸»è¦æ¥å£

å·²æ›´æ–°ä»¥ä¸‹4ä¸ªæ ¸å¿ƒæ¥å£çš„é”™è¯¯å¤„ç†ï¼š

#### `/api/analyze-exam` - è¯•å·åˆ†ææ¥å£
- âœ… ä½¿ç”¨é”™è¯¯æ¶ˆæ¯ç®¡ç†å™¨
- âœ… è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- âœ… è¿”å›å‹å¥½é”™è¯¯å“åº”

#### `/api/analyze-images` - å›¾ç‰‡åˆ†ææ¥å£
- âœ… ä½¿ç”¨é”™è¯¯æ¶ˆæ¯ç®¡ç†å™¨
- âœ… è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- âœ… è¿”å›å‹å¥½é”™è¯¯å“åº”

#### `/api/generate-practice` - ç²¾å‡†è®­ç»ƒç”Ÿæˆæ¥å£
- âœ… ä½¿ç”¨é”™è¯¯æ¶ˆæ¯ç®¡ç†å™¨
- âœ… æ·»åŠ å‚æ•°éªŒè¯ï¼ˆweakPointå¿…éœ€ï¼‰
- âœ… è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- âœ… è¿”å›å‹å¥½é”™è¯¯å“åº”

#### `/api/generate-similar` - ä¸¾ä¸€åä¸‰æ¥å£
- âœ… ä½¿ç”¨é”™è¯¯æ¶ˆæ¯ç®¡ç†å™¨
- âœ… æ·»åŠ å‚æ•°éªŒè¯ï¼ˆquestionTextå¿…éœ€ï¼‰
- âœ… è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- âœ… è¿”å›å‹å¥½é”™è¯¯å“åº”

### 3. æ·»åŠ è¯·æ±‚å‚æ•°éªŒè¯

**éªŒè¯è§„åˆ™**:
- `/api/generate-practice`: å¿…éœ€å‚æ•° `weakPoint`ï¼ˆè–„å¼±ç‚¹ï¼‰
- `/api/generate-similar`: å¿…éœ€å‚æ•° `questionText`ï¼ˆåŸé¢˜å†…å®¹ï¼‰

**éªŒè¯å¤±è´¥æ—¶**:
- è¿”å›400çŠ¶æ€ç 
- ä½¿ç”¨é”™è¯¯æ¶ˆæ¯ç®¡ç†å™¨ç”Ÿæˆå‹å¥½æç¤º
- æä¾›å…·ä½“çš„ç¼ºå¤±å‚æ•°ä¿¡æ¯

### 4. åˆ›å»ºå®Œæ•´çš„æµ‹è¯•å¥—ä»¶

**æ–‡ä»¶**: `backend/test_error_messages.ts`

**æµ‹è¯•è¦†ç›–**:
- âœ… 15ç§é”™è¯¯ç±»å‹çš„æ¶ˆæ¯ç”Ÿæˆ
- âœ… é”™è¯¯ä»£ç æ¨æ–­åŠŸèƒ½ï¼ˆ8ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- âœ… handleErroræ–¹æ³•æµ‹è¯•
- âœ… formatErrorResponseæ–¹æ³•æµ‹è¯•

**æµ‹è¯•ç»“æœ**: 25/25 å…¨éƒ¨é€šè¿‡ ğŸ‰

## ğŸ“Š é”™è¯¯æ¶ˆæ¯ç¤ºä¾‹

### ç¤ºä¾‹1: å›¾ç‰‡è¿‡å¤§

**ä¹‹å‰**:
```json
{
  "success": false,
  "errorMessage": "File size exceeds limit"
}
```

**ç°åœ¨**:
```json
{
  "success": false,
  "errorCode": "ERR_IMAGE_TOO_LARGE",
  "errorMessage": "å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼ˆ15MBï¼‰ï¼Œè¯·å‹ç¼©åé‡è¯•",
  "suggestions": [
    "ä½¿ç”¨æ‰‹æœºç›¸æœºçš„\"æ ‡å‡†\"æ¨¡å¼è€Œé\"é«˜æ¸…\"æ¨¡å¼æ‹ç…§",
    "ä½¿ç”¨å›¾ç‰‡å‹ç¼©å·¥å…·å‡å°æ–‡ä»¶å¤§å°",
    "å»ºè®®å•å¼ å›¾ç‰‡ä¸è¶…è¿‡ 5MB"
  ],
  "technicalDetails": "Image size 15MB exceeds limit 10MB"
}
```

### ç¤ºä¾‹2: OCRè¯†åˆ«å¤±è´¥

**ä¹‹å‰**:
```json
{
  "success": false,
  "errorMessage": "OCR failed"
}
```

**ç°åœ¨**:
```json
{
  "success": false,
  "errorCode": "ERR_OCR_FAILED",
  "errorMessage": "å›¾ç‰‡è¯†åˆ«å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡ä¸æ¸…æ™°æˆ–å…‰çº¿ä¸è¶³",
  "suggestions": [
    "ç¡®ä¿è¯•å·å›¾ç‰‡æ¸…æ™°å¯è§ï¼Œæ–‡å­—å¯è¾¨è®¤",
    "é¿å…å¼ºå…‰åå°„æˆ–é˜´å½±é®æŒ¡",
    "å°è¯•åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸‹é‡æ–°æ‹ç…§",
    "ç¡®ä¿è¯•å·å¹³æ•´ï¼Œé¿å…æŠ˜å æˆ–è¤¶çš±",
    "å¯ä»¥å°è¯•è°ƒæ•´æ‹ç…§è§’åº¦ï¼Œä¿æŒå‚ç›´æ‹æ‘„"
  ],
  "technicalDetails": "OCR processing failed: Service unavailable"
}
```

### ç¤ºä¾‹3: æ— æ•ˆè¯·æ±‚

**ä¹‹å‰**:
```json
{
  "success": false,
  "errorMessage": "ç¼ºå°‘ weakPoint å‚æ•°"
}
```

**ç°åœ¨**:
```json
{
  "success": false,
  "errorCode": "ERR_INVALID_REQUEST",
  "errorMessage": "è¯·æ±‚å‚æ•°ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥è¾“å…¥",
  "suggestions": [
    "æ£€æŸ¥æ‰€æœ‰å¿…å¡«å­—æ®µæ˜¯å¦å·²å¡«å†™",
    "ç¡®ä¿è¾“å…¥æ ¼å¼æ­£ç¡®",
    "å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•"
  ],
  "technicalDetails": "Invalid request: ç¼ºå°‘å¿…éœ€å‚æ•° weakPointï¼ˆè–„å¼±ç‚¹ï¼‰"
}
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. æ™ºèƒ½é”™è¯¯æ¨æ–­
```typescript
errorManager.inferErrorCode(error)
```
- è‡ªåŠ¨ä»Errorå¯¹è±¡æ¨æ–­é”™è¯¯ç±»å‹
- æ”¯æŒè¶…æ—¶ã€ç½‘ç»œã€JSONè§£æç­‰å¸¸è§é”™è¯¯
- æœªçŸ¥é”™è¯¯é»˜è®¤ä¸ºSERVER_ERROR

### 2. ç»Ÿä¸€é”™è¯¯å¤„ç†
```typescript
errorManager.handleError(error, code?)
```
- ä¸€è¡Œä»£ç å¤„ç†æ‰€æœ‰é”™è¯¯
- å¯é€‰æŒ‡å®šé”™è¯¯ä»£ç 
- è‡ªåŠ¨ç”Ÿæˆå‹å¥½æ¶ˆæ¯

### 3. æ ‡å‡†åŒ–å“åº”æ ¼å¼
```typescript
errorManager.formatErrorResponse(errorMessage)
```
- ç»Ÿä¸€çš„JSONå“åº”æ ¼å¼
- åŒ…å«é”™è¯¯ä»£ç ã€æ¶ˆæ¯ã€å»ºè®®ã€æŠ€æœ¯ç»†èŠ‚
- å‰ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨

## ğŸ“ˆ æ•ˆæœè¯„ä¼°

### ç”¨æˆ·ä½“éªŒæå‡
- âœ… é”™è¯¯æ¶ˆæ¯ä»æŠ€æœ¯æœ¯è¯­å˜ä¸ºé€šä¿—æ˜“æ‡‚çš„ä¸­æ–‡
- âœ… æ¯ä¸ªé”™è¯¯éƒ½æä¾›3-5æ¡å…·ä½“çš„è§£å†³å»ºè®®
- âœ… ç”¨æˆ·çŸ¥é“å¦‚ä½•è§£å†³é—®é¢˜ï¼Œè€Œä¸æ˜¯ä¸€å¤´é›¾æ°´

### å¼€å‘ä½“éªŒæå‡
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ–¹å¼ï¼Œä»£ç æ›´ç®€æ´
- âœ… è¯¦ç»†çš„æŠ€æœ¯æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜è¯Šæ–­
- âœ… æ ‡å‡†åŒ–çš„é”™è¯¯ä»£ç ï¼Œä¾¿äºç›‘æ§å’Œç»Ÿè®¡

### å¯ç»´æŠ¤æ€§æå‡
- âœ… é›†ä¸­ç®¡ç†æ‰€æœ‰é”™è¯¯æ¶ˆæ¯
- âœ… æ–°å¢é”™è¯¯ç±»å‹åªéœ€åœ¨ä¸€å¤„æ·»åŠ 
- âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–ï¼Œç¡®ä¿è´¨é‡

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### é”™è¯¯æ¶ˆæ¯ç»“æ„
```typescript
interface ErrorMessage {
  userMessage: string;      // ç”¨æˆ·å‹å¥½çš„é”™è¯¯æè¿°
  technicalMessage: string; // æŠ€æœ¯ç»†èŠ‚ï¼ˆç”¨äºæ—¥å¿—ï¼‰
  suggestions: string[];    // è§£å†³å»ºè®®
  errorCode: string;        // é”™è¯¯ä»£ç 
}
```

### é”™è¯¯ä¸Šä¸‹æ–‡
```typescript
interface ErrorContext {
  code: string;                    // é”™è¯¯ç±»å‹ä»£ç 
  originalError?: Error;           // åŸå§‹é”™è¯¯å¯¹è±¡
  details?: Record<string, any>;   // é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
}
```

### å“åº”æ ¼å¼
```typescript
{
  success: false,
  errorCode: string,
  errorMessage: string,
  suggestions: string[],
  technicalDetails: string
}
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœ¨æ¥å£ä¸­ä½¿ç”¨
```typescript
try {
  // ä¸šåŠ¡é€»è¾‘
} catch (error: any) {
  // ä½¿ç”¨é”™è¯¯æ¶ˆæ¯ç®¡ç†å™¨
  const { getErrorMessageManager } = await import('./core/error-message-manager');
  const errorManager = getErrorMessageManager();
  const errorMessage = errorManager.handleError(error as Error);
  const errorResponse = errorManager.formatErrorResponse(errorMessage);
  
  // è®°å½•æ—¥å¿—
  console.error('ğŸ“‹ é”™è¯¯è¯¦æƒ…:', {
    code: errorMessage.errorCode,
    userMessage: errorMessage.userMessage,
    technicalMessage: errorMessage.technicalMessage
  });
  
  // è¿”å›å“åº”
  res.status(500).json(errorResponse);
}
```

### å‚æ•°éªŒè¯
```typescript
if (!requiredParam) {
  const { getErrorMessageManager } = await import('./core/error-message-manager');
  const errorManager = getErrorMessageManager();
  const errorMessage = errorManager.generateErrorMessage({
    code: 'INVALID_REQUEST',
    details: { reason: 'ç¼ºå°‘å¿…éœ€å‚æ•° xxx' }
  });
  return res.status(400).json(errorManager.formatErrorResponse(errorMessage));
}
```

## âœ… éªŒæ”¶æ ‡å‡†

- [x] åˆ›å»ºé”™è¯¯æ¶ˆæ¯ç®¡ç†å™¨ç±»
- [x] å®šä¹‰15+ç§å¸¸è§é”™è¯¯ç±»å‹
- [x] æ¯ç§é”™è¯¯æä¾›å‹å¥½æ¶ˆæ¯å’Œè§£å†³å»ºè®®
- [x] é›†æˆåˆ°æ‰€æœ‰ä¸»è¦æ¥å£ï¼ˆ4ä¸ªï¼‰
- [x] æ·»åŠ è¯·æ±‚å‚æ•°éªŒè¯
- [x] åˆ›å»ºå®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ25/25ï¼‰
- [x] æ›´æ–°ä»»åŠ¡æ–‡æ¡£

## ğŸ‰ æ€»ç»“

Task 5.1å·²100%å®Œæˆï¼Œå®ç°äº†ï¼š

1. **å®Œæ•´çš„é”™è¯¯æ¶ˆæ¯ç®¡ç†ç³»ç»Ÿ** - è¦†ç›–15+ç§é”™è¯¯ç±»å‹
2. **å…¨é¢çš„æ¥å£é›†æˆ** - 4ä¸ªæ ¸å¿ƒæ¥å£å…¨éƒ¨æ›´æ–°
3. **å‚æ•°éªŒè¯å¢å¼º** - æå‰å‘ç°æ— æ•ˆè¯·æ±‚
4. **å®Œæ•´çš„æµ‹è¯•è¦†ç›–** - 25ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

**ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡**ï¼šä»æŠ€æœ¯é”™è¯¯æ¶ˆæ¯å˜ä¸ºå‹å¥½ã€å…·ä½“ã€å¯æ“ä½œçš„æç¤ºï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿè§£å†³é—®é¢˜ã€‚

**ä¸‹ä¸€æ­¥**: å¯ä»¥å¼€å§‹Task 5.2å’Œ5.3ï¼ˆéœ€è¦å‰ç«¯é…åˆï¼‰æˆ–ç»§ç»­å…¶ä»–P1ä»»åŠ¡ã€‚
