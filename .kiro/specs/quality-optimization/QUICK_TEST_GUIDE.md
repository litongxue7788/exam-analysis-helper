# P0 修复 - 快速测试指南

## 🚀 5 分钟快速测试

### 前提条件
- ✅ 后端服务运行中: http://localhost:3002
- ✅ 前端服务运行中: http://localhost:3000

### 测试步骤

#### 1. 打开前端 (1 分钟)
```
浏览器访问: http://localhost:3000
```

#### 2. 上传试卷图片 (1 分钟)
- 点击"上传试卷"按钮
- 选择一张包含数学公式的试卷图片
- 等待分析完成

#### 3. 检查输出质量 (2 分钟)

**检查点 1: 无 LaTeX 代码**
- ❌ 不应该看到: `$x^2$`, `\sqrt{}`, `\frac{}`
- ✅ 应该看到: `x²`, `√`, `(1/2)`

**检查点 2: 无 Markdown 标记**
- ❌ 不应该看到: ` ``` `, 反引号
- ✅ 应该看到: 干净的文本

**检查点 3: 证据完整**
- ✅ 每个错因分析应包含:
  - 【知识点】
  - 【题号】
  - 【得分】(格式: X/Y)
  - 【错因】
  - 【证据】
  - 【置信度】
  - 【最短改法】

**检查点 4: 练习题相关**
- ✅ 练习题应该针对识别出的错因
- ✅ 知识点应该匹配

#### 4. 检查后端日志 (1 分钟)

打开后端终端，查找以下日志消息:

```bash
# 内容清洗日志
✅ [Content Sanitizer] 内容已清洗，修改了 X 处

# 证据验证日志
⚠️ [Evidence Validation] Problem X 缺少必需字段  # 如果有问题
⚠️ [Evidence Validation] Problem X 得分格式不正确  # 如果有问题

# 相关性验证日志
✅ [Relevance Validator] 整体相关性: X%
✅ [Relevance Validator] X/X 题目相关
```

---

## 🧪 运行自动化测试

### 测试脚本
```bash
cd backend
npx ts-node test_p0_fixes.ts
```

### 预期输出
```
================================================================================
P0 质量优化功能测试
================================================================================

【测试1】内容清洗 - LaTeX公式转换
✅ 成功: LaTeX已转换为Unicode

【测试2】内容清洗 - Markdown标记移除
✅ 成功: Markdown标记已移除

【测试3】可读性验证
干净文本可读性: ✅ 通过
脏文本可读性: ✅ 正确检测

【测试4】练习题相关性验证
相关题目测试: ✅ 通过
不相关题目测试: ✅ 正确检测

【测试5】证据格式验证
有效问题: ✅ 通过
无效问题1: ✅ 正确检测
无效问题2: ✅ 正确检测

所有P0功能正常工作！
```

---

## 🔍 详细测试场景

### 场景 1: 数学试卷
**目的**: 测试 LaTeX 转换

**测试数据**: 包含数学公式的试卷
- 二次方程: x² + 2x + 1 = 0
- 根号: √2, √(x² + y²)
- 分数: ½, ¼, (a+b)/c

**预期结果**:
- ✅ 所有公式都是 Unicode 符号
- ✅ 没有 `$...$` 或 `\...` 代码

### 场景 2: 多题型试卷
**目的**: 测试证据验证

**测试数据**: 包含多种题型的试卷
- 选择题
- 填空题
- 解答题

**预期结果**:
- ✅ 每个错因都有完整的七要素
- ✅ 得分格式都是 "X/Y"
- ✅ 证据具体明确

### 场景 3: 复杂错因
**目的**: 测试练习题相关性

**测试数据**: 包含多个错因的试卷
- 计算错误
- 概念混淆
- 方法不当

**预期结果**:
- ✅ 练习题针对具体错因
- ✅ 相关性得分 ≥ 60%
- ✅ 知识点匹配

---

## 📊 质量检查清单

### 输出质量
- [ ] 无 LaTeX 代码 (`$...$`, `\sqrt{}`, `\frac{}`)
- [ ] 无 Markdown 标记 (` ``` `, 反引号)
- [ ] 无乱码或特殊字符
- [ ] 数学符号使用 Unicode (x², √, ≤, ±)

### 证据完整性
- [ ] 每个问题有【知识点】
- [ ] 每个问题有【题号】
- [ ] 每个问题有【得分】(格式: X/Y)
- [ ] 每个问题有【错因】
- [ ] 每个问题有【证据】(具体明确)
- [ ] 每个问题有【置信度】(高/中/低)
- [ ] 每个问题有【最短改法】

### 练习题质量
- [ ] 练习题针对识别出的错因
- [ ] 知识点匹配
- [ ] 题型相似
- [ ] 难度适当

### 日志监控
- [ ] 看到内容清洗日志
- [ ] 看到证据验证日志
- [ ] 看到相关性验证日志
- [ ] 没有严重错误

---

## 🐛 常见问题排查

### 问题 1: 仍然看到 LaTeX 代码

**可能原因**:
- 清洗器未正确集成
- LaTeX 模式未被识别

**排查步骤**:
1. 检查后端日志是否有清洗消息
2. 检查 `parseLlmJson()` 是否调用了 `sanitizeJsonString()`
3. 检查 LaTeX 模式是否在转换映射表中

**解决方案**:
- 更新 `sanitizer.ts` 中的 LaTeX 模式
- 添加新的转换规则

### 问题 2: 证据验证警告过多

**可能原因**:
- LLM 未遵循提示词要求
- 提示词不够明确

**排查步骤**:
1. 检查 `prompts.ts` 中的输出规范
2. 检查 LLM 响应的原始内容
3. 检查验证逻辑是否过于严格

**解决方案**:
- 优化提示词，更明确地说明要求
- 调整验证阈值
- 添加更多示例

### 问题 3: 相关性得分过低

**可能原因**:
- 练习题生成提示词不够具体
- 相关性计算逻辑需要调整

**排查步骤**:
1. 检查练习题内容
2. 检查错因分析内容
3. 检查相关性计算逻辑

**解决方案**:
- 优化练习题生成提示词
- 调整相关性权重
- 添加更多匹配维度

---

## 📞 获取帮助

### 查看文档
- **实施总结**: `.kiro/specs/quality-optimization/IMPLEMENTATION_SUMMARY.md`
- **集成指南**: `.kiro/specs/quality-optimization/INTEGRATION_GUIDE.md`
- **测试指南**: `.kiro/specs/quality-optimization/TESTING_GUIDE.md`
- **完成报告**: `.kiro/specs/quality-optimization/P0_COMPLETION_REPORT.md`

### 检查日志
```bash
# 后端日志
# 查看终端输出，搜索:
# - [Content Sanitizer]
# - [Evidence Validation]
# - [Relevance Validator]
```

### 运行测试
```bash
cd backend
npx ts-node test_p0_fixes.ts
```

---

**祝测试顺利！** 🎉
