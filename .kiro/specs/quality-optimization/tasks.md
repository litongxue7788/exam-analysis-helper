# Implementation Plan: 试卷分析质量优化

## Overview

本实施计划针对P0级别的紧急质量问题，立即修复影响用户体验的核心缺陷：
1. 输出内容可读性（乱码问题）
2. 分析报告内容准确性（内容不符问题）
3. 练习题目相关性（题目不符问题）

## Tasks

### P0 - 紧急修复（立即执行）

- [x] 1. 实现内容清洗管道
  - [x] 1.1 创建ContentSanitizer类
    - 实现Markdown标记清理
    - 实现LaTeX公式转换
    - 实现特殊字符过滤
    - 实现编码验证
    - _Requirements: 3.1, 3.2, 3.3, 3.4_

  - [x] 1.2 集成到LLM输出处理流程
    - 在parseLlmJson后添加清洗步骤
    - 在所有文本输出前进行清洗
    - 记录清洗日志
    - _Requirements: 3.5_

  - [x] 1.3 添加内容清洗测试
    - 测试Markdown清理
    - 测试LaTeX转换
    - 测试特殊字符过滤
    - _Requirements: 3.1, 3.2, 3.3_

- [x] 2. 优化提示词确保输出准确性
  - [x] 2.1 增强提示词结构化要求
    - 明确要求基于图片内容分析
    - 强调不得编造内容
    - 要求使用标准中文
    - 禁止使用LaTeX和特殊符号
    - _Requirements: 2.1, 2.2, 8.2, 8.3_

  - [x] 2.2 添加输出格式示例
    - 在提示词中添加正确格式示例
    - 明确六要素格式要求
    - 强调得分格式："X/Y"
    - _Requirements: 2.2, 8.1_

  - [x] 2.3 添加输出验证规则
    - 验证必需字段完整性
    - 验证得分格式正确性
    - 验证证据非空
    - _Requirements: 2.3, 6.2_

- [x] 3. 实现练习题相关性验证
  - [x] 3.1 创建RelevanceValidator类
    - 实现知识点匹配检查
    - 实现题型匹配检查
    - 实现难度匹配检查
    - 计算相关性得分
    - _Requirements: 4.1, 4.2, 4.3_

  - [x] 3.2 集成到练习题生成流程
    - 生成后自动验证相关性
    - 低相关性自动重新生成
    - 记录相关性得分
    - _Requirements: 4.4, 4.5_

  - [x] 3.3 添加相关性验证测试
    - 测试知识点匹配
    - 测试题型匹配
    - 测试相关性得分计算
    - _Requirements: 4.1, 4.2, 4.3_

- [x] 4. 增强证据链绑定
  - [x] 4.1 验证证据完整性
    - 检查题号非空
    - 检查得分格式
    - 检查证据非空
    - 检查置信度标注
    - _Requirements: 2.2, 2.3_

  - [x] 4.2 添加证据来源追溯
    - 记录证据来自哪张图片
    - 标注证据在图片中的位置
    - 提供"查看原图"功能
    - _Requirements: 2.4_

  - [x] 4.3 添加证据验证测试
    - 测试必需字段验证
    - 测试格式验证
    - 测试证据非空验证
    - _Requirements: 2.2, 2.3_

- [x] 5. 优化错误提示和用户反馈
  - [x] 5.1 改进错误消息
    - 提供具体错误原因
    - 给出解决建议
    - 避免泛泛的错误提示
    - _Requirements: 7.1_

  - [x] 5.2 添加用户反馈入口（后端部分）
    - 在分析结果旁添加"反馈"按钮（需前端）
    - 收集用户对准确性的评价
    - 记录错误详情供优化
    - _Requirements: 7.3, 7.4_

  - [x] 5.3 添加低置信度提示（后端部分）
    - 明确标注低置信度结果
    - 提供手动修正入口（需前端）
    - 建议重新拍照
    - _Requirements: 1.2, 7.2_

### P1 - 高优先级（P0完成后执行）

- [x] 6. 实现分段交付优化
  - [x] 6.1 优化SSE事件推送
    - 推送识别进度
    - 推送核心分析结果
    - 推送完整报告
    - _Requirements: 5.3, 5.4_

  - [x] 6.2 实现渐进式加载
    - 先显示摘要
    - 再显示Top3错因
    - 最后显示完整报告
    - _Requirements: 10.3_

  - [x] 6.3 优化时长估算
    - 根据图片数量估算
    - 实时更新剩余时间
    - 提供跳过等待选项
    - _Requirements: 5.4, 10.4_

- [x] 7. 实现输出质量保证
  - [x] 7.1 添加输出完整性验证
    - 验证所有必需字段
    - 验证字段格式正确
    - 验证内容非空
    - _Requirements: 6.1, 6.2, 6.3_

  - [x] 7.2 添加质量评分机制
    - 计算识别置信度
    - 计算分析置信度
    - 计算证据完整性
    - 计算内容可读性
    - _Requirements: 6.4, 6.5_

  - [x] 7.3 添加质量保证测试
    - 测试完整性验证
    - 测试质量评分
    - 测试端到端质量
    - _Requirements: 6.1, 6.2, 6.3_

- [x] 8. 优化年级识别准确性 ✅ **新增**
  - [x] 8.1 扩展知识点数据库
    - 新增12个高中数学知识点
    - 覆盖圆锥曲线、椭圆、双曲线、抛物线
    - 覆盖解析几何、参数方程、复数、矩阵
    - 从40个扩展到52个知识点
    - _Requirements: 内容准确性_

  - [x] 8.2 优化年级推断算法
    - 实现动态权重调整（标题置信度高时提高权重）
    - 改进难度判断逻辑（更精确的阈值）
    - 添加学段一致性检查
    - 优化知识点匹配权重（高置信度×1.5）
    - _Requirements: 内容准确性_

  - [x] 8.3 提高标题识别置信度
    - 精确匹配年级时置信度提高到95%
    - 触发动态权重调整机制
    - 避免跨学段误判
    - _Requirements: 内容准确性_

### P2 - 中优先级（长期优化）

- [x] 8. 实现图片质量检查
  - [x] 8.1 创建ImageQualityChecker类
    - 检测图片亮度
    - 检测图片清晰度
    - 检测图片倾斜
    - _Requirements: 1.3_

  - [x] 8.2 集成到上传流程
    - 前端实时检查
    - 后端二次验证
    - 提供改进建议
    - _Requirements: 1.3, 1.4_

- [x] 9. 实现双模型验证
  - [x] 9.1 创建DualModelValidator类
    - 关键信息双模型验证
    - 不一致时智能选择
    - 记录验证结果
    - _Requirements: 9.4_

  - [x] 9.2 集成到识别流程
    - 题号双模型验证
    - 得分双模型验证
    - 提升准确性
    - _Requirements: 1.1, 9.4_

- [x] 10. 实现用户体验优化
  - [x] 10.1 添加进度可视化
    - 显示当前阶段
    - 显示进度百分比
    - 显示预计时间
    - _Requirements: 10.2_

  - [x] 10.2 添加查看原图功能（部分完成）
    - ✅ 后端证据来源追溯已完成
    - ✅ 证据位置记录已完成
    - ⚠️ 前端图片查看器UI未实现（用户选择不实现）
    - _Requirements: 2.4, 10.4_
    - _Note: 核心后端支持已完成，前端UI可在后续迭代中补充_

  - [x] 10.3 优化移动端体验
    - 响应式设计（所有组件）
    - 图片上传优化（拖拽+点击）
    - 结果展示优化（卡片式布局）
    - 交互流程优化（智能确认、自动分析）
    - _Requirements: 10.1, 10.2_

## Notes

- P0任务必须在24小时内完成
- 每完成一个任务立即测试验证
- 发现问题立即修复，不拖延
- 保持与用户的持续沟通
- 所有修改必须向后兼容

## Success Criteria

**P0完成标准**:
- ✅ 输出内容100%可读，无乱码、无LaTeX代码
- ✅ 分析报告100%基于试卷内容，无编造
- ✅ 练习题相关性≥85%
- ✅ 所有错因分析包含完整六要素
- ✅ 用户可以清晰理解每个分析结论的依据

**P1完成标准**:
- ✅ 核心分析结果≤30秒返回
- ✅ 完整报告≤60秒返回
- ✅ 输出质量评分≥90分
- ✅ 用户满意度≥4.5/5.0

**P2完成标准**:
- ✅ 识别准确率≥95%
- ✅ 图片质量检查准确率≥90%
- ✅ 双模型验证提升准确性≥5%
- ✅ 移动端体验流畅度≥90分
