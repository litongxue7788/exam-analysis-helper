# 需求文档 - 基于试卷内容的智能分析

## 简介

本功能旨在完全依据试卷图片识别的内容（包括试卷标题、知识点、题目难度等）来自动确定学生的年级、学科等信息，并以此作为生成所有输出内容（分析报告、错题本、学习方法、练习题等）的唯一依据，彻底避免用户输入与试卷内容不符的问题。

## 术语表

- **试卷内容识别**：从试卷图片中提取的所有信息，包括标题、题目、知识点、难度等
- **知识点分析**：根据试卷题目内容判断所属的知识点和难度级别
- **年级推断**：基于知识点难度和内容自动推断学生所在年级
- **内容一致性**：确保所有输出内容与试卷识别结果完全一致

---

## 需求 1：基于知识点的年级智能推断

**用户故事**：作为系统，我需要根据试卷中的知识点和题目难度自动推断学生年级，这样即使试卷标题不清晰或用户填写错误，也能确保分析准确。

### 验收标准

1. WHEN 试卷包含"一元二次方程"、"二次函数"等知识点 THEN 系统 SHALL 推断为初中或高中年级
2. WHEN 试卷包含"加减乘除"、"认识图形"等知识点 THEN 系统 SHALL 推断为小学年级
3. WHEN 试卷包含"导数"、"立体几何"等知识点 THEN 系统 SHALL 推断为高中年级
4. WHEN 知识点推断与试卷标题推断冲突 THEN 系统 SHALL 优先使用知识点推断结果
5. WHEN 知识点推断置信度低于阈值 THEN 系统 SHALL 标记为"需要人工确认"并使用保守估计

---

## 需求 2：完全禁用用户输入的年级和学科

**用户故事**：作为产品经理，我希望系统完全忽略用户手动填写的年级和学科信息，只使用试卷识别结果，这样可以避免用户填写错误导致的分析偏差。

### 验收标准

1. WHEN 用户填写年级信息 THEN 系统 SHALL 记录但不使用该信息
2. WHEN 用户填写学科信息 THEN 系统 SHALL 记录但不使用该信息
3. WHEN 生成分析报告 THEN 系统 SHALL 仅使用试卷识别的年级和学科
4. WHEN 生成练习题 THEN 系统 SHALL 仅使用试卷识别的知识点和难度
5. WHEN 用户输入与识别结果差异较大 THEN 系统 SHALL 在报告中添加提示信息

---

## 需求 3：基于试卷内容的学科确认

**用户故事**：作为系统，我需要根据试卷的题目类型和知识点自动确认学科，确保学科判断准确。

### 验收标准

1. WHEN 试卷包含"计算题"、"应用题"、"几何题" THEN 系统 SHALL 确认学科为数学
2. WHEN 试卷包含"阅读理解"、"作文"、"文言文" THEN 系统 SHALL 确认学科为语文
3. WHEN 试卷包含"完形填空"、"语法选择"、"写作" THEN 系统 SHALL 确认学科为英语
4. WHEN 试卷标题学科与题目类型学科冲突 THEN 系统 SHALL 优先使用题目类型判断
5. WHEN 学科判断置信度低于阈值 THEN 系统 SHALL 标记为"需要人工确认"

---

## 需求 4：知识点难度分析

**用户故事**：作为系统，我需要分析试卷中每个知识点的难度级别，以便更准确地推断年级和生成针对性练习。

### 验收标准

1. WHEN 分析试卷题目 THEN 系统 SHALL 为每个知识点标注难度级别（基础/中等/困难）
2. WHEN 知识点难度集中在基础级别 THEN 系统 SHALL 推断为低年级
3. WHEN 知识点难度集中在困难级别 THEN 系统 SHALL 推断为高年级
4. WHEN 知识点跨越多个难度级别 THEN 系统 SHALL 综合判断年级范围
5. WHEN 难度分析完成 THEN 系统 SHALL 在日志中输出详细的难度分布

---

## 需求 5：内容一致性验证

**用户故事**：作为质量保证人员，我需要系统验证所有输出内容与试卷识别结果的一致性，确保不会出现"高中试卷输出小学内容"的问题。

### 验收标准

1. WHEN 生成分析报告 THEN 系统 SHALL 验证报告中的知识点与试卷识别的知识点一致
2. WHEN 生成练习题 THEN 系统 SHALL 验证练习题难度与试卷难度匹配
3. WHEN 生成学习方法 THEN 系统 SHALL 验证学习方法适合识别出的年级
4. WHEN 发现内容不一致 THEN 系统 SHALL 记录警告并重新生成
5. WHEN 内容一致性验证通过 THEN 系统 SHALL 在日志中输出"✅ 内容一致性验证通过"

---

## 需求 6：知识点库匹配

**用户故事**：作为系统，我需要维护一个知识点库，将试卷中的知识点与标准知识点库匹配，以便准确判断年级和学科。

### 验收标准

1. WHEN 系统启动 THEN 系统 SHALL 加载知识点库（包含知识点名称、所属学科、适用年级、难度级别）
2. WHEN 识别到试卷知识点 THEN 系统 SHALL 在知识点库中查找匹配项
3. WHEN 找到匹配项 THEN 系统 SHALL 使用知识点库中的标准信息
4. WHEN 未找到匹配项 THEN 系统 SHALL 使用模糊匹配或标记为"未知知识点"
5. WHEN 知识点匹配完成 THEN 系统 SHALL 输出匹配结果和置信度

---

## 需求 7：多维度年级推断

**用户故事**：作为系统，我需要综合多个维度（试卷标题、知识点、题目难度、题型）来推断年级，提高推断准确性。

### 验收标准

1. WHEN 分析试卷 THEN 系统 SHALL 从试卷标题提取年级信息（维度1）
2. WHEN 分析试卷 THEN 系统 SHALL 从知识点推断年级范围（维度2）
3. WHEN 分析试卷 THEN 系统 SHALL 从题目难度推断年级范围（维度3）
4. WHEN 分析试卷 THEN 系统 SHALL 从题型分布推断年级范围（维度4）
5. WHEN 多维度推断完成 THEN 系统 SHALL 综合所有维度得出最终年级（加权平均或投票机制）
6. WHEN 各维度推断结果差异较大 THEN 系统 SHALL 降低置信度并标记为"需要人工确认"

---

## 需求 8：输出内容强制绑定

**用户故事**：作为开发人员，我需要确保所有输出内容（报告、练习题、学习方法）都强制使用试卷识别结果，不允许使用用户输入。

### 验收标准

1. WHEN 生成诊断报告 THEN 系统 SHALL 使用试卷识别的年级调用 `getGradeLevelInstruction()`
2. WHEN 生成诊断报告 THEN 系统 SHALL 使用试卷识别的学科调用 `getSubjectAnalysisInstruction()`
3. WHEN 生成练习题 THEN 系统 SHALL 使用试卷识别的学科调用 `getSubjectPracticeInstruction()`
4. WHEN 生成学习方法 THEN 系统 SHALL 使用试卷识别的知识点和难度
5. WHEN 构建响应 THEN 系统 SHALL 在 meta 中使用试卷识别的所有信息
6. WHEN 代码中存在用户输入的年级/学科变量 THEN 系统 SHALL 不使用这些变量

---

## 需求 9：识别结果置信度评估

**用户故事**：作为系统，我需要评估试卷识别结果的置信度，当置信度较低时提示用户确认。

### 验收标准

1. WHEN 试卷标题清晰且包含年级信息 THEN 系统 SHALL 标记置信度为"高"
2. WHEN 知识点匹配度高且难度一致 THEN 系统 SHALL 标记置信度为"高"
3. WHEN 试卷标题模糊或缺失年级信息 THEN 系统 SHALL 标记置信度为"中"
4. WHEN 知识点匹配度低或难度不一致 THEN 系统 SHALL 标记置信度为"低"
5. WHEN 置信度为"低" THEN 系统 SHALL 在报告中添加"⚠️ 识别置信度较低，建议人工确认"
6. WHEN 置信度为"高" THEN 系统 SHALL 在日志中输出"✅ 识别置信度高，可直接使用"

---

## 需求 10：用户输入降级为参考信息

**用户故事**：作为产品经理，我希望用户输入的年级和学科信息仅作为参考，不影响实际分析，但可以在识别失败时作为备选。

### 验收标准

1. WHEN 试卷识别成功 THEN 系统 SHALL 完全使用识别结果，忽略用户输入
2. WHEN 试卷识别失败（置信度极低） THEN 系统 SHALL 使用用户输入作为备选
3. WHEN 使用用户输入作为备选 THEN 系统 SHALL 在报告中明确标注"⚠️ 基于用户输入，非试卷识别"
4. WHEN 用户输入与识别结果差异较大 THEN 系统 SHALL 在日志中记录差异信息
5. WHEN 用户未填写任何信息且识别失败 THEN 系统 SHALL 返回错误提示"无法确定年级和学科，请重新上传清晰的试卷图片"

---

## 优先级

- **P0（必须立即实现）**：
  - 需求 1：基于知识点的年级智能推断
  - 需求 2：完全禁用用户输入的年级和学科
  - 需求 5：内容一致性验证
  - 需求 8：输出内容强制绑定

- **P1（重要，近期实现）**：
  - 需求 3：基于试卷内容的学科确认
  - 需求 4：知识点难度分析
  - 需求 7：多维度年级推断
  - 需求 9：识别结果置信度评估

- **P2（优化，后续实现）**：
  - 需求 6：知识点库匹配
  - 需求 10：用户输入降级为参考信息

---

## 非功能性需求

### 性能要求
- 知识点分析和年级推断应在 2 秒内完成
- 知识点库查询应在 100ms 内完成

### 可靠性要求
- 年级推断准确率应达到 90% 以上
- 学科判断准确率应达到 95% 以上

### 可维护性要求
- 知识点库应支持动态更新
- 推断逻辑应模块化，便于调整权重

---

## 验收标准总结

本功能完成后，系统应能够：
1. ✅ 完全基于试卷内容自动确定年级和学科
2. ✅ 忽略用户手动填写的年级和学科信息
3. ✅ 确保所有输出内容与试卷识别结果一致
4. ✅ 提供详细的识别日志和置信度评估
5. ✅ 在识别失败时给出明确的错误提示

---

**文档版本**：v1.0  
**创建日期**：2026-01-11  
**状态**：待审核
