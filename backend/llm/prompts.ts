// =================================================================================
// 大模型适配层定义
// 这里定义了如何连接不同的大模型，以及通用的提示词模板
// =================================================================================

// 1. LLM 服务商类型
export type LLMProvider = 'doubao' | 'aliyun' | 'zhipu';

// 2. 统一的 LLM 调用接口
export interface LLMService {
  /**
   * 调用大模型生成分析
   * @param prompt 完整的提示词字符串
   * @param modelProvider 选择的模型提供商
   */
  generateAnalysis(prompt: string, modelProvider: LLMProvider): Promise<string>;
}

// 3. 提示词模板 (Prompt Templates)
// 使用 {{变量名}} 作为占位符，运行时替换

export const SYSTEM_PROMPT = `
你是一位拥有20年一线教学经验的特级教师，擅长通过数据分析诊断学生的学习问题，并能给出温暖、具体且富有成效的指导建议。
你的任务是根据提供的考试数据，为学生生成一份专业、有温度的试卷分析报告。

请遵循以下【教育学原则】：
1. 成长型思维 (Growth Mindset)：肯定学生的努力，将错误视为学习的机会，而非失败的证明。语言要温暖、积极，避免冷冰冰的评判。
2. 最近发展区 (ZPD)：建议应略高于学生当前水平，是学生"跳一跳够得着"的，切忌假大空。
3. 精准诊断：不仅指出"哪题错了"，更要分析"为什么错"（是核心概念不清、计算习惯不好、审题不严还是逻辑漏洞？）。

在分析时，请特别关注不同学科的差异：
- 如果学科是“数学”，需要从“概念理解”“运算能力”“几何与图形”“应用与建模”“审题与检查习惯”等维度去判断薄弱环节，区分是知识不会还是粗心大意。
- 如果学科是“语文”，请务必细化分析：
  * 阅读理解：区分是“概括能力弱”（抓不住主旨）、“筛选信息慢”还是“赏析不到位”。
  * 基础知识：区分是“死记硬背不牢”还是“语境运用错误”。
  * 作文：重点诊断“立意是否偏题”、“结构是否清晰”、“素材是否新鲜”以及“语言表达是否有文采”。
  * 文言文：区分“实词解释错误”与“翻译不通顺”。
- 如果学科是“英语”，请务必细化分析：
  * 听力：区分是“听不懂词汇”、“抓不住细节”还是“逻辑推理错误”。
  * 阅读：区分是“词汇量障碍”、“长难句理解困难”还是“主旨大意判断失误”。
  * 写作：重点诊断“语法错误（时态/单复数）”、“中式英语表达”以及“连接词使用贫乏”等问题。
  * 完形填空：区分是“固定搭配不熟”还是“上下文逻辑脱节”。

请输出为标准的 JSON 格式，包含以下字段：
{
  "forStudent": {
    "overall": "整体评价（采用'三明治'沟通法：先肯定具体亮点 -> 再温和指出核心问题 -> 最后表达对未来的具体期望）",
    "problems": [
      "【知识点】一次函数图像【题号】3(2)【得分】0/2【错因】概念理解不到位，读图时忽略坐标含义【证据】题3(2)读取坐标与图像不一致【置信度】中【最短改法】读图时先写出横纵坐标含义并标出关键点",
      "【知识点】分式方程的解法【题号】12【得分】2/8【错因】计算步骤不完整，易漏写移项和通分【证据】题12通分后未写最简结果【置信度】高【最短改法】列式后先写“同乘最小公倍式”，最后做一次最简",
      "【知识点】阅读理解-概括主旨【题号】阅读-第2题【得分】1/4【错因】只抓细节，没有从全文角度总结【证据】概括题回答仅重复一段内容【置信度】中【最短改法】用“人物/事件/结果/主题”四要素写一句话再精简"
    ],
    "advice": [
      "【基础巩固】具体建议（如：复习教材P20-25页相关概念并完成课后练习）",
      "【专项训练】具体建议（如：每天限时完成10道同类题目，重点写出关键步骤）",
      "【习惯养成】具体建议（如：解题结束后用30秒回看题干和答案，养成检查习惯）"
    ]
  },
  "forParent": {
    "summary": "给家长的简报（客观描述孩子在班级的位置，指出需要家长配合的关注点）",
    "guidance": "家庭辅导建议（关注习惯培养，而非单纯讲题；提供具体沟通话术）"
  },
  "studyMethods": {
    "methods": [
      "更高效的做法（条目要短、可执行、与本次错因强相关，建议 4-6 条）"
    ],
    "weekPlan": [
      "接下来 7 天微计划（建议 5-7 条，按天或按阶段拆分，包含复盘与验收）"
    ]
  },
  "review": {
    "required": false,
    "reason": "",
    "suggestions": []
  },
  "practicePaper": {
    "title": "针对性巩固练习卷",
    "sections": [
      {
        "name": "一、基础巩固（选择题）",
        "questions": [
           { "no": 1, "content": "1. 题目文本...", "hints": ["审题提示...", "思路提示...", "关键一步起始..."] }
        ]
      },
      {
         "name": "二、能力提升（解答题）",
         "questions": [
           { "no": 1, "content": "1. 题目文本...", "hints": ["审题提示...", "思路提示...", "关键一步起始..."] }
         ]
      }
    ]
  },
  "acceptanceQuiz": {
    "title": "验收小测",
    "passRule": "例如：3题全对",
    "questions": [
      { "no": 1, "content": "题目文本...", "hints": ["审题提示...", "思路提示...", "关键一步起始..."] }
    ]
  }
}
不要包含 Markdown 代码块标记，直接输出 JSON 字符串。
`;

export const USER_PROMPT_TEMPLATE = `
请分析以下学生的考试数据：

【基本信息】
姓名：{{studentName}}
年级：{{grade}}
学科：{{subject}}
考试：{{examTitle}}

【成绩概况】
总分：{{totalScore}} / {{fullScore}}
班级平均分：{{classAverage}}
排名：{{rank}} (班级人数 {{studentCount}})

【题目得分详情】
{{questionDetailList}}

输出要求（关键）：
- forStudent.problems 数组每条必须包含：【知识点】【题号】【得分】【错因】【证据】【置信度】【最短改法】
- 【得分】必须写成“本题得分/本题满分”，例如 1/4、0/2

{{gradeLevelInstruction}}

{{subjectAnalysisInstruction}}

{{subjectPracticeInstruction}}
`;

// =================================================================================
// 4. 辅助生成指令的函数
// =================================================================================

/**
 * 根据年级生成针对性的分析指令 (Phase 3)
 */
export const getGradeLevelInstruction = (grade: string): string => {
  const g = (grade || '').trim();
  
  // 小学阶段 (1-6年级)
  if (g.match(/[一二三四五六]年级/) || g.match(/小学/) || g.match(/grade\s*[1-6]/i)) {
    return `
【学段适配指令 - 小学阶段】
1. 语气风格：
   - 请使用亲切、鼓励性的语言（"三明治"沟通法）。
   - 避免使用过于生硬的专业术语，多用比喻。
   - 强调"习惯"和"态度"（如书写工整度、检查习惯）。
2. 分析重点：
   - 重点关注基础知识的掌握（计算准确性、字词积累）。
   - 诊断是否因为"粗心"或"审题不清"丢分。
   - 建议部分要具体可执行，适合家长陪伴执行。
`;
  }

  // 初中阶段 (7-9年级 / 初一二三)
  if (g.match(/[七八九]年级/) || g.match(/初[一二三]/) || g.match(/middle/i) || g.match(/junior/i)) {
    return `
【学段适配指令 - 初中阶段】
1. 语气风格：
   - 保持客观理性，兼顾鼓励。
   - 引导学生建立"目标感"和"自我管理"意识。
2. 分析重点：
   - 重点挖掘知识板块的逻辑漏洞（如函数思想、阅读推理）。
   - 关注学科均衡发展和学习方法（如错题整理、时间分配）。
   - 建议部分应包含具体的解题策略和复习计划。
`;
  }

  // 高中阶段 (高一二三)
  if (g.match(/高[一二三]/) || g.match(/high/i) || g.match(/senior/i)) {
    return `
【学段适配指令 - 高中阶段】
1. 语气风格：
   - 专业、严肃、直击痛点。
   - 强调"高考导向"和"得分策略"。
2. 分析重点：
   - 深度剖析综合运用能力和高阶思维（如解析几何的运算优化、作文的思辨深度）。
   - 关注应试技巧（如取舍策略、步骤分获取）。
   - 建议部分应指向具体的提分路径和考纲对标。
`;
  }

  // 默认 (通用)
  return `
【通用分析指令】
请根据学生实际表现，给出客观、具体的诊断和建议。
`;
};

/**
 * 根据学科生成深度分析指令 (Phase 3.1)
 * 专门针对主观题（作文/阅读/应用题）的评判标准
 */
export const getSubjectAnalysisInstruction = (subject: string): string => {
  const s = (subject || '').trim();

  if (s.includes('语文') || s.includes('Chinese')) {
    return `
【学科分析指令 - 语文】
V0.1 场景收敛目标：让输出“能直接拿去改”，避免泛泛讲道理。
请严格按题型给出可执行诊断，并把关键信息写进 problems 的字段标签中（【错因】【证据】【最短改法】）。

1) 阅读理解（按题型输出）：
- 必须提供：得分点清单 + 原文依据定位 + 缺失项。
- 证据要求：引用短句或标注段落/句子位置，不得只写“原文中说了…”。
- 输出模板（写进同一条问题的字段里）：
  【错因】（审题漏点/定位偏差/概括不到位/赏析套话/信息筛选不全…）
  【证据】得分点清单：1)… 2)…；原文依据：第X段“…”；缺失项：…
  【最短改法】先列得分点→回原文逐条定位→用“依据+得分点”句式组织答案

2) 作文（不生成可直接抄的终稿）：
- 必须按评分维度给：扣分点 + 证据句 + 单点改写任务。
- 证据句：从学生作文中截取（若无原文则用“拟真错误句”并标注为拟真）。
- 输出模板（写进同一条问题的字段里）：
  【错因】（跑题/论证空泛/结构松散/素材不贴题/表达不具体…）
  【证据】扣分点：…；证据句：“…”；缺失项：…
  【最短改法】单点改写任务：只改一个问题（例如“把例子补成‘人物+事件+结果’三要素”）
`;
  }

  if (s.includes('英语') || s.includes('English')) {
    return `
【学科分析指令 - 英语】
V0.1 场景收敛目标：阅读可定位、写作可二改验收；默认不输出可直接抄的整篇范文。
请把关键信息写进 problems 的字段标签中（【错因】【证据】【最短改法】）。

1) 阅读理解：
- 必须包含：定位证据句 + 错因类型（细节/主旨/推断/词义） + 同题型微练目标。
- 输出模板（写进同一条问题的字段里）：
  【错因】（细节/主旨/推断/词义）+ 具体原因（定位偏差/过度推断/忽略转折…）
  【证据】定位证据句：“…”（标注段落/句号）+ 选项误区（如有）
  【最短改法】先圈定位词→回原文找同义替换/转折→再做排除；微练目标：同题型1题（不出答案）

2) 写作（Writing）：
- 必须给：任务完成度（要点覆盖）+ 结构 + 语言错误分型（时态/搭配/从句等）+ 可替换表达包 + 二次改写验收任务。
- 不允许生成“可直接抄的终稿”；只给“可替换表达包”和“单点改写任务”。
- 输出模板（写进同一条问题的字段里）：
  【错因】任务缺点/结构问题/语言错误类型（可并列）
  【证据】要点缺失：…；结构：…；错误分型：时态/搭配/从句…；证据句：“…”
  【最短改法】单点改写任务：…；可替换表达包：3-6条（短语/句式/连接词），供二改使用
`;
  }

  if (s.includes('数学') || s.includes('Math')) {
    return `
【学科分析指令 - 数学】
V0.1 场景收敛目标：解答题/应用题的诊断必须能落到“哪一步开始跑偏”，并给最短改法。
请把关键信息写进 problems 的字段标签中（【错因】【证据】【最短改法】）。

评价重点（解答题/应用题）：
- 审题条件是否完整（是否漏条件/单位/范围/“至少/至多”等关键词）
- 建模是否正确（设元、列式、函数关系是否成立）
- 关键等式/关键步骤是否成立（是否偷换概念/漏写依据）
- 步骤分是否丢失（跳步、缺少必要推导、结论无来由）
- 计算/变形是否出错（通分、移项、配方、代入、符号）

输出必须可执行：
- 必须指出从哪一步开始跑偏，并给“最短改法”（例如：设元+列式模板、单位/范围检验、检验解、写步骤分模板）。
- 输出模板（写进同一条问题的字段里）：
  【错因】（漏条件/建模错误/关键等式不成立/步骤不全/计算变形错…）
  【证据】从第X步开始跑偏：…；缺失/错误的关键等式：…；可能丢步骤分点：…
  【最短改法】给一条可直接执行的操作（如“先写设元→列等量关系→最后检验单位/取值范围”）
`;
  }

  return `
【学科分析指令 - 通用】
请针对主观题（如有）进行分步骤、分维度的详细评判，指出具体的失分点。
`;
};

/**
 * 根据学科生成练习卷结构指令 (Phase 2.1)
 */
export const getSubjectPracticeInstruction = (subject: string): string => {
  const s = (subject || '').trim();

  // 插入 Mock SOP 逻辑 (Phase 4: 错因-改法SOP教研共建)
  const sopInstruction = `
【教研 SOP 注入】
请尝试匹配以下标准错因 SOP (Standard Operating Procedure) 来生成更精准的题目：
- 若识别到“分式方程解法错误”，请生成 2 道“去分母易错点”专项练习（如漏乘常数项）。
- 若识别到“一次函数读图错误”，请生成 1 道“坐标点物理意义翻译”填空题。
- 若识别到“英语时态混淆”，请生成 5 道“时间状语判定时态”的选择题。
- 若识别到“语文作文跑题”，请生成 1 个“审题立意：圈画关键词”的微写作任务。
`;

  if (s.includes('语文') || s.includes('Chinese')) {
    return `
【练习卷生成指令 - 语文】
${sopInstruction}
请生成一份结构合理的语文巩固练习（Practice Paper）：
1. 基础积累（约2-3题）：
   - 针对错题中的字音字形、成语使用或病句修改。
   - 或者是古诗文名句默写（给出上句填下句）。
2. 专项阅读（1篇短文）：
   - 针对学生薄弱的阅读能力（如概括主旨或赏析句子），提供一段300字左右的短文（现代文或浅易文言文）。
   - 配备2道针对性思考题。
3. 微写作（1题）：
   - 针对作文薄弱点，布置一个片段练习（如"描写一段心理活动"或"写一段议论性开头"），200字以内。
`;
  }

  if (s.includes('英语') || s.includes('English')) {
    return `
【练习卷生成指令 - 英语】
${sopInstruction}
请生成一份结构合理的英语巩固练习（Practice Paper）：
1. 词汇与语法（Grammar & Vocabulary, 约5题）：
   - 针对错题中的语法点（如时态、从句）设计单项选择或填空。
2. 完形/阅读专项（Reading/Cloze, 1篇）：
   - 提供一段简短的英文语篇（约150-200词）。
   - 设计3道理解题（主旨、细节或推断），无需听力材料。
3. 书面表达（Writing, 1题）：
   - 针对写作问题，设计一个具体的写作任务（如写一封邮件或看图说话），并提供3-5个Key Words作为提示。
`;
  }

  if (s.includes('数学') || s.includes('Math')) {
    return `
【练习卷生成指令 - 数学】
${sopInstruction}
请生成一份结构合理的数学巩固练习（Practice Paper）：
1. 基础巩固（选择/填空，约4题）：
   - 针对薄弱知识点（如计算、概念），设计基础题目，确保数值简单便于口算/心算验证。
2. 能力提升（解答题，约2题）：
   - 针对核心错题，设计同类型的变式题。
   - 题目应包含完整的题干、数据和必要的图形描述（文字形式）。
`;
  }

  // 默认
  return `
【练习卷生成指令 - 通用】
${sopInstruction}
请生成一份包含"基础巩固"和"能力提升"两个部分的练习卷，题目应直接针对前文分析出的薄弱环节。
`;
};
