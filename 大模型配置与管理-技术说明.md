试卷分析助手 - 大模型配置与管理技术说明

本说明面向后续接手开发的同事，重点描述「大模型调用配置」和「管理员在界面配置秘钥」这一块的整体设计与代码位置，方便维护和扩展。

---

一、整体目标与角色

- 管理目标
  - 所有大模型调用（结构化分析 + 图片分析）都由后端统一管理秘钥。
  - 管理者可以在前端界面上输入一次 API Key / 模型 ID 并保存到服务器。
  - 任课老师只负责上传试卷、生成报告，不需要也看不到任何秘钥。
- 角色
  - 管理员：配置大模型服务商（豆包 / 通义 / 智谱）的 Key 和模型 ID。
  - 老师：使用工具生成学生分析报告。

当前实现的是「单实例、本地部署」下的最简版本，为后续多学校、多 Key 管理预留了空间。

---

二、配置加载与优先级

1. 环境变量（.env）

- 文件：`backend/.env`
- 相关字段：
  - `DOUBAO_API_KEY` / `DOUBAO_BASE_URL` / `DOUBAO_MODEL_ID`
  - `ALIYUN_API_KEY` / `ALIYUN_BASE_URL` / `ALIYUN_MODEL_ID`
  - `ZHIPU_API_KEY` / `ZHIPU_BASE_URL` / `ZHIPU_MODEL_ID`
  - `DEFAULT_PROVIDER`：`doubao | aliyun | zhipu`
  - `ADMIN_PASSWORD`：管理员操作前端配置界面时需要输入的密码
- 作用：
  - 作为启动时的默认配置来源，尤其适用于首次部署或没有 `llm.json` 时。

2. 本地配置文件（llm.json）

- 文件路径：`config/llm.json`（运行时由后端创建 / 更新）
- 结构示例：

```json
{
  "doubao": {
    "apiKey": "your_api_key",
    "model": "your_model_id",
    "baseURL": "https://ark.cn-beijing.volces.com/api/v3"
  },
  "defaultProvider": "doubao"
}
```

- 加载逻辑：
  - 位置：`backend/server.ts` 中 `loadLlmConfigFromFile` 函数。
  - 服务启动时：
    - 如果存在 `llm.json`：
      - 读取文件并解析 JSON。
      - 对每个 provider（doubao/aliyun/zhipu）调用 `llmService.setProviderConfig` 覆盖内存中的配置。
      - 如果存在 `defaultProvider`，写入 `process.env.DEFAULT_PROVIDER`。
    - 如果不存在 `llm.json`：
      - 保持使用 `.env` 中的配置。

3. 生效优先级

1）服务启动时：
- 若有 `config/llm.json` → 优先用此文件内容覆盖运行时配置。
- 若无 `llm.json` → 使用 `.env` 中的配置。

2）运行过程中：
- 管理员通过前端配置界面保存后：
  - 内存中的配置立即更新（`llmService.setProviderConfig`）。
  - 同时写回 `config/llm.json`，作为后续重启时的持久化来源。

---

三、后端大模型服务层设计

1. 类型与接口定义

- 文件：`backend/llm/interface.ts`
- 核心类型：
  - `LLMProvider = 'doubao' | 'aliyun' | 'zhipu'`
- 核心接口：

```ts
export interface LLMService {
  generateAnalysis(prompt: string, modelProvider: LLMProvider): Promise<string>;
  generateImageAnalysis(images: string[], prompt: string, provider: LLMProvider): Promise<string>;
}
```

2. 实现类与配置结构

- 文件：`backend/llm/service.ts`

```ts
interface ProviderConfig {
  apiKey: string;
  baseURL: string;
  model: string;
}

export class LLMServiceImpl implements LLMService {
  private configs: Record<LLMProvider, ProviderConfig>;

  constructor() {
    this.configs = {
      doubao: {
        apiKey: process.env.DOUBAO_API_KEY || '',
        baseURL: process.env.DOUBAO_BASE_URL || 'https://ark.cn-beijing.volces.com/api/v3',
        model: process.env.DOUBAO_MODEL_ID || '',
      },
      aliyun: {
        apiKey: process.env.ALIYUN_API_KEY || '',
        baseURL: process.env.ALIYUN_BASE_URL || 'https://dashscope.aliyuncs.com/compatible-mode/v1',
        model: process.env.ALIYUN_MODEL_ID || 'qwen-plus',
      },
      zhipu: {
        apiKey: process.env.ZHIPU_API_KEY || '',
        baseURL: process.env.ZHIPU_BASE_URL || 'https://open.bigmodel.cn/api/paas/v4',
        model: process.env.ZHIPU_MODEL_ID || 'glm-4',
      }
    };
  }
```

- 动态配置接口：

```ts
getProviderConfig(provider: LLMProvider): ProviderConfig {
  return this.configs[provider];
}

setProviderConfig(provider: LLMProvider, config: Partial<ProviderConfig>): void {
  this.configs[provider] = {
    ...this.configs[provider],
    ...config,
  };
}
```

- 调用方法：
  - 文本分析：`generateAnalysis(prompt, provider)`
  - 图片分析：`generateImageAnalysis(images, prompt, provider)`
  - 两者都会检查对应 provider 的 `apiKey` 是否存在，否则抛出错误要求检查配置。

---

四、后端管理接口设计

1. 管理接口路径与行为

- 文件：`backend/server.ts`
- 路径：`POST /api/admin/llm-config`
- 请求体示例：

```json
{
  "adminPassword": "xxxx",
  "provider": "doubao",
  "apiKey": "sk-xxx",
  "modelId": "ep-xxx",
  "baseURL": "https://ark.cn-beijing.volces.com/api/v3"
}
```

- 处理逻辑：
  1. 读取 `process.env.ADMIN_PASSWORD`，若未配置 → 返回 500。
  2. 校验 `adminPassword` 是否匹配：
     - 不匹配 → 返回 401 + 错误信息“管理员密码错误”。
  3. 确定目标 provider：
     - 若请求体有 `provider` → 使用之；
     - 否则使用 `DEFAULT_PROVIDER`；
     - 若都没有 → 默认 `doubao`。
  4. 调用 `llmService.getProviderConfig(p)` 获取当前配置。
  5. 调用 `llmService.setProviderConfig(p, {...})` 更新内存中的配置。
  6. 读取现有 `config/llm.json`（若存在），更新对应 provider 的字段，并写回文件。
  7. 返回 `{ success: true }`。

2. 配置载入函数

- 函数：`loadLlmConfigFromFile`
- 作用：
  - 服务启动时检查并加载 `config/llm.json`，覆盖内存配置；
  - 设置 `process.env.DEFAULT_PROVIDER`（若有）。

---

五、前端管理界面设计

1. 入口位置

- 文件：`frontend/web/src/components/SettingsModal.tsx`
- 状态字段：
  - `isAdminMode`：是否展开管理员配置区。
  - `adminPassword`：管理员密码输入。
  - `adminMessage`：操作反馈信息（成功 / 失败）。
  - `adminSaving`：保存中状态。

2. 老师视角

- 设置弹窗中有一行说明：
  - 文本：`大模型服务由管理员统一配置，老师无需设置。`
  - 同时提供一个“小按钮”：`管理员配置`
  - 普通老师不需要点击即可正常使用分析功能。

3. 管理员视角（展开后）

- 展开管理员区域后，显示以下字段：
  1. 模型服务商选择（`ModelSelector`，与业务分析页共享）
  2. 管理员密码输入框（用于校验 `ADMIN_PASSWORD`）
  3. 模型 ID / 接入点 ID 输入框
  4. Base URL 输入框（可选，默认官方地址）
  5. API Key 输入框（以密码形式显示）
  6. 保存按钮：
     - 文案：`保存大模型配置到服务器`
     - 点击后请求 `POST /api/admin/llm-config`
     - 根据响应在下方展示成功或错误提示文本。

4. 与老师使用的关系

- 老师侧调用分析接口时，不需要也不传递任何 API Key：
  - 文字分析接口使用当前 `DEFAULT_PROVIDER` 与后端配置。
  - 图片分析接口仅传 `provider`（服务商标识），不传 Key：

```ts
const payload = {
  images: base64Images,
  provider: llmConfig.provider,
};
```

- 后端基于当前 provider 的配置（内存 + llm.json /.env）进行真实调用。

---

六、未来扩展建议

1. 多环境支持

- 目前设计适合单机部署（本地电脑 / 单台服务器）。
- 若未来采用多环境（dev / test / prod）：
  - 建议使用不同的 `.env` 与 `llm.json`。
  - 可在配置中增加 `env` 字段或根据 NODE_ENV 区分文件。

2. 授权码 / 租户机制

- 若将来要为不同学校 / 班级分配不同 Key 或额度：
  - 可在后端引入“租户 / 授权码”字段；
  - 老师首次登录输入授权码 → 服务端关联到特定 provider 配置；
  - 同样避免在前端暴露真实 Key。

3. 安全与审计

- 建议在生产环境中：
  - 使用 `.gitignore` 忽略 `config/llm.json`，避免误提交到仓库；
  - 控制能访问 `/api/admin/llm-config` 的网络范围（如仅内网、仅特定 IP）；
  - 后续可以增加操作日志记录（谁在什么时候更新了配置）。

---

七、快速排错指南

1. 报错：“未配置 xxx 的 API Key，请检查 .env 文件”

- 意味着对应 provider 的 `apiKey` 为空。
- 检查项：
  - `.env` 中是否配置了对应字段；
  - 若使用了管理界面更新，确认 `config/llm.json` 中对应字段是否存在且不为空；
  - 若刚修改 `.env`，是否已重启后端服务。

2. 报错：“管理员密码错误”

- 检查 `.env` 中 `ADMIN_PASSWORD` 是否与前端输入一致。
- 修改 `ADMIN_PASSWORD` 后需要重启后端服务。

3. 报错：“保存失败，请检查密码和配置”

- 可能原因：
  - 管理接口返回非 200 状态；
  - 响应中 `success` 为 false；
  - 或写入 `llm.json` 失败（如没有写权限）。
- 建议：
  - 查看后端控制台日志，查找 `❌ 管理接口处理失败` 相关输出；
  - 检查 `config` 目录是否存在，当前用户是否有写入权限。

本说明随代码一起维护，若后续对大模型服务商适配、配置方式或管理界面有调整，建议同步更新此文档以便交接。***
