# 手机端访问口令问题解决方案

## 问题描述

在手机端访问公网部署的系统时，即使在设置中输入了正确的访问口令，仍然提示"口令失效"或"访问口令错误"。

---

## 问题原因

这是由于浏览器缓存导致的。访问口令保存在浏览器的 `localStorage` 中，但在某些情况下：

1. **旧版本缓存**: 浏览器缓存了旧版本的页面代码
2. **Service Worker**: PWA的Service Worker缓存了旧资源
3. **HTTP缓存**: 浏览器HTTP缓存未更新
4. **localStorage未同步**: 口令保存后页面未正确刷新

---

## 解决方案

### 方案1: 强制刷新页面（推荐）

#### iOS Safari
1. 打开页面
2. 点击地址栏旁边的 **刷新按钮** 并长按
3. 选择 **"重新加载"** 或 **"清除缓存并重新加载"**

或者：
1. 在设置中输入访问口令
2. 点击保存
3. **完全关闭Safari应用**（从多任务界面划掉）
4. 重新打开Safari，访问网站

#### Android Chrome
1. 打开页面
2. 点击右上角 **⋮** 菜单
3. 选择 **"刷新"** 或按住刷新按钮选择 **"强制刷新"**

或者：
1. 在设置中输入访问口令
2. 点击保存
3. 点击地址栏
4. 在地址栏前面添加 `?t=` + 当前时间戳（例如：`?t=123456`）
5. 回车访问

---

### 方案2: 清除浏览器缓存

#### iOS Safari
1. 打开 **设置** → **Safari**
2. 向下滚动，点击 **"清除历史记录与网站数据"**
3. 确认清除
4. 重新打开网站，输入访问口令

#### Android Chrome
1. 打开 **Chrome** → **设置**
2. 点击 **"隐私设置和安全性"**
3. 点击 **"清除浏览数据"**
4. 选择 **"缓存的图片和文件"**
5. 点击 **"清除数据"**
6. 重新打开网站，输入访问口令

---

### 方案3: 使用无痕/隐私模式

#### iOS Safari
1. 打开Safari
2. 点击右下角 **标签页** 图标
3. 点击 **"私密浏览"**
4. 访问网站，输入访问口令

#### Android Chrome
1. 打开Chrome
2. 点击右上角 **⋮** 菜单
3. 选择 **"新建无痕式标签页"**
4. 访问网站，输入访问口令

**注意**: 无痕模式下，关闭浏览器后访问口令会丢失，需要重新输入。

---

### 方案4: 在URL中添加时间戳参数

这个方法可以绕过浏览器缓存：

```
原URL: https://your-domain.com
新URL: https://your-domain.com?refresh=20260113
```

每次访问时修改时间戳即可强制刷新。

---

## 验证口令是否生效

### 方法1: 检查浏览器控制台

1. 在手机浏览器中打开 **开发者工具**（部分浏览器支持）
2. 在控制台输入：
   ```javascript
   localStorage.getItem('trialAccessCode')
   ```
3. 如果返回你输入的口令，说明已保存成功

### 方法2: 查看网络请求

1. 打开浏览器开发者工具
2. 切换到 **Network（网络）** 标签
3. 上传图片进行分析
4. 查看请求头中是否包含 `x-access-code`

---

## 预防措施

### 1. 添加版本号到URL

在部署新版本后，可以在URL中添加版本号：
```
https://your-domain.com?v=1.0.1
```

### 2. 配置HTTP缓存头

在 `nginx.conf` 中添加：
```nginx
location / {
    # 禁用HTML文件缓存
    location ~* \.html$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # 静态资源使用版本号缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 3. 使用Service Worker更新策略

在前端代码中添加Service Worker更新检测：
```javascript
// 检测新版本
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(registration => {
    registration.addEventListener('updatefound', () => {
      const newWorker = registration.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          // 提示用户刷新
          if (confirm('发现新版本，是否立即更新？')) {
            window.location.reload();
          }
        }
      });
    });
  });
}
```

---

## 常见问题

### Q1: 为什么电脑端正常，手机端不行？

**A**: 可能是因为：
- 手机浏览器缓存策略更激进
- 手机网络环境不同（可能使用了运营商缓存）
- 手机浏览器版本较旧

**解决**: 使用上述方案1或方案2清除缓存。

---

### Q2: 清除缓存后还是不行？

**A**: 请检查：
1. 访问口令是否输入正确（注意大小写）
2. 访问口令是否有多余的空格
3. 服务器端口令配置是否正确
4. 网络是否正常（尝试访问其他网站）

**验证服务器配置**:
```bash
# SSH登录服务器
ssh root@your-server-ip

# 查看后端日志
pm2 logs exam-helper-backend --lines 50

# 检查.env配置
cat /opt/exam-analysis-helper/backend/.env | grep TRIAL_ACCESS_CODES
```

---

### Q3: 每次都要重新输入口令？

**A**: 这是正常的，如果：
- 使用无痕/隐私模式
- 浏览器设置为"退出时清除数据"
- 手机系统清理了浏览器数据

**解决**: 
- 不使用无痕模式
- 在浏览器设置中关闭"退出时清除数据"
- 将网站添加到主屏幕（PWA模式）

---

### Q4: 如何确认口令是否有效？

**A**: 联系管理员，使用以下命令查看有效口令：
```bash
# 在服务器上运行
bash 查看访问口令.sh
```

或者使用API测试：
```bash
curl -X POST http://your-domain.com/api/analyze \
  -H "Content-Type: application/json" \
  -H "x-access-code: YOUR-ACCESS-CODE" \
  -d '{"images":[]}'
```

如果返回 `{"error":"请提供至少一张图片"}` 说明口令有效。
如果返回 `{"error":"访问口令无效"}` 说明口令无效。

---

## 技术说明

### 访问口令的工作原理

1. **前端存储**: 口令保存在 `localStorage.trialAccessCode`
2. **请求携带**: 每次API请求在请求头中添加 `x-access-code`
3. **后端验证**: 服务器检查口令是否在 `TRIAL_ACCESS_CODES` 列表中
4. **限流控制**: 每个口令有独立的请求频率和配额限制

### localStorage的特点

- **持久化**: 关闭浏览器后仍然保留
- **域名隔离**: 不同域名的localStorage互不影响
- **容量限制**: 通常为5-10MB
- **同步操作**: 读写是同步的，不会有延迟

### 缓存层级

浏览器缓存有多个层级：
1. **Memory Cache**: 内存缓存（最快，但关闭标签页就清除）
2. **Disk Cache**: 磁盘缓存（持久化，但可能过期）
3. **Service Worker Cache**: PWA缓存（需要手动更新）
4. **HTTP Cache**: 基于HTTP头的缓存（由服务器控制）

---

## 联系支持

如果以上方案都无法解决问题，请联系技术支持并提供：

1. **设备信息**: 手机型号、操作系统版本
2. **浏览器信息**: 浏览器名称和版本
3. **错误截图**: 包含完整的错误提示
4. **操作步骤**: 详细描述你的操作过程
5. **网络环境**: WiFi还是移动网络

---

**文档版本**: 1.0  
**更新日期**: 2026-01-13  
**适用版本**: v1.0.0+
