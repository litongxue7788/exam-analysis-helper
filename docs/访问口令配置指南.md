# 访问口令配置指南

## 概述

本系统使用访问口令机制来控制试点范围和使用配额。

## 用户端配置

### 手机端/Web端设置

1. 打开应用设置界面（点击右上角⚙️图标）
2. 找到"试点访问口令"输入框
3. 输入管理员提供的访问口令
4. 点击保存
5. 刷新页面

### 常见问题

**Q: 显示"口令失效"或"访问口令错误"？**

A: 请检查：
- 口令是否输入正确（注意大小写）
- 是否有多余的空格
- 联系管理员确认口令是否有效

**Q: 口令保存在哪里？**

A: 口令保存在浏览器的localStorage中，关闭浏览器后仍然保留。

**Q: 如何清除已保存的口令？**

A: 在设置界面清空"试点访问口令"输入框并保存。

## 管理员配置

### 服务器端配置

编辑 `backend/.env` 文件：

```bash
# 访问口令配置（多个口令用英文逗号分隔）
TRIAL_ACCESS_CODES=code1,code2,code3

# 留空则不需要口令验证
# TRIAL_ACCESS_CODES=
```

**口令格式建议**：
- 使用随机字符串
- 长度建议10-20个字符
- 包含字母、数字、连字符
- 示例格式：`PREFIX-T01-XXXXXX`

### 配额限制配置

```bash
# 限流配置
RATE_LIMIT_PER_MINUTE_PER_CODE=30    # 每分钟请求数/口令
RATE_LIMIT_PER_MINUTE_PER_IP=25      # 每分钟请求数/IP
DAILY_QUOTA_PER_CODE=350             # 每日请求数/口令
DAILY_QUOTA_PER_IP=350               # 每日请求数/IP
```

### 管理操作

#### 添加新口令

```bash
# 1. 编辑配置文件
nano backend/.env

# 2. 在TRIAL_ACCESS_CODES后面添加新口令（用逗号分隔）
TRIAL_ACCESS_CODES=existing_codes,new_code

# 3. 重启服务
pm2 restart exam-helper-backend
```

#### 禁用某个口令

```bash
# 1. 编辑配置文件
nano backend/.env

# 2. 从TRIAL_ACCESS_CODES中删除对应的口令

# 3. 重启服务
pm2 restart exam-helper-backend
```

#### 临时禁用口令验证（仅测试环境）

```bash
# 1. 编辑配置文件
nano backend/.env

# 2. 将TRIAL_ACCESS_CODES设置为空
TRIAL_ACCESS_CODES=

# 3. 重启服务
pm2 restart exam-helper-backend
```

⚠️ **安全警告**：
- 禁用口令验证会让任何人都能访问服务
- 仅在内网测试环境使用
- 生产环境务必启用口令验证

## 技术实现

### 前端实现

前端在每次API请求时自动添加口令：

```typescript
// 请求头方式
headers: {
  'x-access-code': 'your_access_code'
}

// URL参数方式（SSE连接）
?accessCode=your_access_code
```

### 后端验证

服务器端验证逻辑：

```typescript
// 从环境变量读取配置的口令列表
const requiredCodes = process.env.TRIAL_ACCESS_CODES?.split(',') || [];

// 从请求中获取口令
const gotCode = req.headers['x-access-code'] || req.query.accessCode;

// 验证口令
if (requiredCodes.length > 0 && !requiredCodes.includes(gotCode)) {
  return res.status(401).json({ 
    success: false, 
    errorMessage: '访问口令错误或缺失' 
  });
}
```

## 安全建议

### 口令管理

✅ **推荐做法**：
- 为不同用户/组织分配不同口令
- 定期更换口令
- 使用强随机口令
- 记录口令分配情况
- 监控口令使用情况

❌ **避免做法**：
- 使用简单易猜的口令
- 在公开渠道分享口令
- 长期不更换口令
- 将口令提交到代码仓库

### 配置文件安全

⚠️ **重要提醒**：
- `.env` 文件包含敏感信息，已被 `.gitignore` 忽略
- 不要将 `.env` 文件提交到Git仓库
- 不要在文档中暴露真实口令
- 服务器上的 `.env` 文件权限应设置为 `600`

```bash
# 设置正确的文件权限
chmod 600 backend/.env
```

## 故障排查

### 问题：服务启动后仍提示口令错误

**排查步骤**：

1. 检查环境变量是否正确加载
```bash
# 查看PM2环境变量
pm2 env 0

# 或查看进程信息
pm2 show exam-helper-backend
```

2. 检查.env文件格式
```bash
# 确认没有多余空格或特殊字符
cat backend/.env | grep TRIAL_ACCESS_CODES
```

3. 重启服务
```bash
pm2 restart exam-helper-backend
```

### 问题：PM2日志为空

**可能原因**：
- 服务启动失败
- 日志文件路径错误
- 权限问题

**解决方案**：
```bash
# 查看PM2状态
pm2 status

# 查看错误日志
pm2 logs exam-helper-backend --err --lines 100

# 重新启动
pm2 delete exam-helper-backend
pm2 start ecosystem.config.js
```

## 监控和统计

### 查看口令使用情况

服务器日志会记录：
- 使用的口令
- 请求来源IP
- 请求时间
- 配额使用情况

### 配额超限处理

当用户超过配额限制时：
- 返回429状态码
- 提示"请求过于频繁"
- 建议等待或联系管理员

## 相关文档

- `docs/部署和运维指南.md` - 部署指南
- `docs/CONFIG_TEMPLATE.md` - 配置模板
- `backend/.env.example` - 环境变量示例

---

**注意**：本文档不包含真实的访问口令。如需获取访问口令，请联系系统管理员。
