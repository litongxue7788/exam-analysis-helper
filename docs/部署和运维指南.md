# 试卷分析系统 - 部署和运维指南

## 📋 文档概述

本文档提供试卷分析系统（质量优化版本v2.0）的部署和运维指南。

**版本**: v2.0  
**更新日期**: 2026年1月12日  
**适用环境**: 生产环境、测试环境

---

## 🚀 快速部署

### 前置要求

**系统要求**:
- Node.js ≥ 16.x
- npm ≥ 8.x 或 yarn ≥ 1.22.x
- 操作系统: Linux/macOS/Windows

**外部服务**:
- 大模型API（豆包/阿里云/智谱至少一个）
- 存储空间: ≥10GB（用于缓存和日志）

---

### 1. 环境配置

#### 创建配置文件
```bash
# 复制环境变量模板
cp backend/.env.example backend/.env

# 编辑配置文件
vim backend/.env
```

#### 必需的环境变量
```bash
# 大模型配置（至少配置一个）
DOUBAO_API_KEY=your_doubao_api_key
DOUBAO_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
DOUBAO_MODEL=your_model_id

ALIYUN_API_KEY=your_aliyun_api_key
ALIYUN_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
ALIYUN_MODEL=qwen-plus

ZHIPU_API_KEY=your_zhipu_api_key
ZHIPU_BASE_URL=https://open.bigmodel.cn/api/paas/v4
ZHIPU_MODEL=glm-4-plus

# 默认提供商
DEFAULT_PROVIDER=doubao

# 服务端口
PORT=3002

# 并发控制
MAX_CONCURRENT_JOBS=2

# 缓存配置
IMAGE_ANALYZE_CACHE_TTL_MS=604800000  # 7天
JOB_TTL_MS=7200000                     # 2小时

# 超时配置
LLM_TIMEOUT_MS=120000                  # 2分钟
LLM_RETRY_COUNT=1
LLM_RETRY_BASE_DELAY_MS=800

# Hedge请求配置（可选）
HEDGE_ENABLED=1
HEDGE_AFTER_MS=3800
HEDGE_AFTER_MS_PER_IMAGE=450
HEDGE_SECONDARY_PROVIDER=aliyun
```

#### 可选的环境变量
```bash
# 日志级别
LOG_LEVEL=info

# 数据目录
DATA_DIR=./data

# 反馈存储目录
FEEDBACK_DIR=./data/feedbacks

# 最大内存中任务数
MAX_JOBS_IN_MEMORY=200

# 事件缓冲区大小
JOB_EVENT_BUFFER_SIZE=40
```

---

### 2. 安装依赖

```bash
# 安装后端依赖
cd backend
npm install

# 安装前端依赖（如果有）
cd ../frontend
npm install
```

---

### 3. 启动服务

#### 开发模式
```bash
# 启动后端开发服务器
cd backend
npm run dev

# 启动前端开发服务器（另一个终端）
cd frontend
npm run dev
```

#### 生产模式
```bash
# 构建前端
cd frontend
npm run build

# 启动后端生产服务器
cd backend
npm run start
```

---

## 🔧 配置详解

### 大模型配置

#### 配置文件方式
除了环境变量，也可以使用配置文件：

```json
// config/llm.json
{
  "doubao": {
    "apiKey": "your_api_key",
    "baseURL": "https://ark.cn-beijing.volces.com/api/v3",
    "model": "your_model_id"
  },
  "aliyun": {
    "apiKey": "your_api_key",
    "baseURL": "https://dashscope.aliyuncs.com/compatible-mode/v1",
    "model": "qwen-plus"
  },
  "zhipu": {
    "apiKey": "your_api_key",
    "baseURL": "https://open.bigmodel.cn/api/paas/v4",
    "model": "glm-4-plus"
  },
  "defaultProvider": "doubao"
}
```

**优先级**: 环境变量 > 配置文件

---

### 并发和性能配置

#### 并发任务数
```bash
# 同时处理的分析任务数
MAX_CONCURRENT_JOBS=2

# 建议值:
# - 单核CPU: 1-2
# - 双核CPU: 2-4
# - 四核CPU: 4-8
```

#### 缓存配置
```bash
# 分析结果缓存时间（毫秒）
IMAGE_ANALYZE_CACHE_TTL_MS=604800000  # 7天

# 任务记录保留时间（毫秒）
JOB_TTL_MS=7200000  # 2小时

# 内存中最大任务数
MAX_JOBS_IN_MEMORY=200
```

#### 超时配置
```bash
# LLM调用超时时间（毫秒）
LLM_TIMEOUT_MS=120000  # 2分钟

# 重试次数
LLM_RETRY_COUNT=1

# 重试延迟基数（毫秒）
LLM_RETRY_BASE_DELAY_MS=800
```

---

### Hedge请求配置

Hedge请求是一种提高可靠性的技术，当主请求超时时自动发起备用请求。

```bash
# 启用Hedge请求
HEDGE_ENABLED=1

# 主请求超时后多久发起备用请求（毫秒）
HEDGE_AFTER_MS=3800

# 每张图片增加的等待时间（毫秒）
HEDGE_AFTER_MS_PER_IMAGE=450

# 备用提供商
HEDGE_SECONDARY_PROVIDER=aliyun
```

**工作原理**:
1. 发起主请求（如使用豆包）
2. 等待 HEDGE_AFTER_MS + (图片数 × HEDGE_AFTER_MS_PER_IMAGE) 毫秒
3. 如果主请求还未完成，发起备用请求（如使用阿里云）
4. 哪个请求先完成就使用哪个结果

---

## 📊 监控和日志

### 日志位置

**后端日志**:
- 控制台输出
- 可配置输出到文件（需要添加日志库）

**关键日志标记**:
- `✅` - 成功操作
- `⚠️` - 警告信息
- `❌` - 错误信息
- `🚀` - 系统启动
- `📊` - 统计信息

### 监控指标

#### 系统指标
```bash
# 查看当前运行的任务数
curl http://localhost:3002/api/health

# 响应示例
{
  "status": "healthy",
  "runningJobs": 2,
  "queuedJobs": 5,
  "cacheSize": 150,
  "uptime": 3600
}
```

#### 性能指标
- **平均响应时间**: 30-60秒（取决于图片数量）
- **并发处理能力**: 2-8个任务（取决于配置）
- **缓存命中率**: 建议≥30%

#### 质量指标
- **识别准确率**: ≥90%
- **分析准确率**: ≥95%
- **证据完整性**: 100%
- **内容可读性**: 100%

---

## 🔍 故障排查

### 常见问题

#### 1. 服务无法启动

**症状**: 运行 `npm run dev` 后报错

**可能原因**:
- 端口被占用
- 环境变量未配置
- 依赖未安装

**解决方案**:
```bash
# 检查端口占用
lsof -i :3002  # macOS/Linux
netstat -ano | findstr :3002  # Windows

# 检查环境变量
cat backend/.env

# 重新安装依赖
cd backend
rm -rf node_modules
npm install
```

---

#### 2. LLM调用失败

**症状**: 分析任务失败，日志显示"API Key缺失"或"调用超时"

**可能原因**:
- API Key未配置或错误
- 网络连接问题
- API配额用尽

**解决方案**:
```bash
# 检查API Key配置
echo $DOUBAO_API_KEY

# 测试网络连接
curl -I https://ark.cn-beijing.volces.com

# 检查API配额（查看提供商控制台）

# 切换到备用提供商
export DEFAULT_PROVIDER=aliyun
```

---

#### 3. 分析速度慢

**症状**: 分析任务耗时超过2分钟

**可能原因**:
- 图片数量多
- 并发任务过多
- LLM响应慢

**解决方案**:
```bash
# 增加并发数（如果CPU允许）
export MAX_CONCURRENT_JOBS=4

# 启用Hedge请求
export HEDGE_ENABLED=1

# 减少超时时间
export LLM_TIMEOUT_MS=90000

# 检查缓存命中率
# 如果缓存命中率低，考虑增加缓存时间
export IMAGE_ANALYZE_CACHE_TTL_MS=1209600000  # 14天
```

---

#### 4. 内存占用高

**症状**: 服务器内存占用持续增长

**可能原因**:
- 任务记录未清理
- 缓存过大
- 内存泄漏

**解决方案**:
```bash
# 减少内存中任务数
export MAX_JOBS_IN_MEMORY=100

# 减少任务保留时间
export JOB_TTL_MS=3600000  # 1小时

# 减少缓存时间
export IMAGE_ANALYZE_CACHE_TTL_MS=86400000  # 1天

# 重启服务
pm2 restart exam-analysis
```

---

#### 5. 证据验证失败

**症状**: 日志显示"证据不完整"警告

**可能原因**:
- LLM输出格式不规范
- 提示词需要优化

**解决方案**:
```bash
# 检查LLM输出日志
# 查看是否缺少必需字段

# 如果是特定提供商的问题，切换提供商
export DEFAULT_PROVIDER=aliyun

# 如果问题持续，联系开发团队优化提示词
```

---

## 🔐 安全建议

### API Key管理
- ✅ 使用环境变量存储API Key
- ✅ 不要将API Key提交到代码仓库
- ✅ 定期轮换API Key
- ✅ 为不同环境使用不同的API Key

### 访问控制
- ✅ 使用防火墙限制访问
- ✅ 启用HTTPS（生产环境）
- ✅ 实施速率限制
- ✅ 添加身份验证（如需要）

### 数据安全
- ✅ 定期备份用户反馈数据
- ✅ 加密敏感数据
- ✅ 遵守数据保护法规
- ✅ 定期清理过期数据

---

## 📦 备份和恢复

### 需要备份的数据

#### 1. 用户反馈数据
```bash
# 备份位置
data/feedbacks/user-feedbacks.jsonl

# 备份命令
cp data/feedbacks/user-feedbacks.jsonl backup/feedbacks-$(date +%Y%m%d).jsonl
```

#### 2. 配置文件
```bash
# 备份配置
cp backend/.env backup/env-$(date +%Y%m%d)
cp config/llm.json backup/llm-$(date +%Y%m%d).json
```

#### 3. 缓存数据（可选）
```bash
# 如果使用文件缓存
cp -r data/cache backup/cache-$(date +%Y%m%d)
```

### 恢复流程

```bash
# 1. 停止服务
pm2 stop exam-analysis

# 2. 恢复配置
cp backup/env-20260112 backend/.env
cp backup/llm-20260112.json config/llm.json

# 3. 恢复数据
cp backup/feedbacks-20260112.jsonl data/feedbacks/user-feedbacks.jsonl

# 4. 重启服务
pm2 start exam-analysis
```

---

## 🔄 更新和升级

### 版本更新流程

#### 1. 备份当前版本
```bash
# 备份代码
git tag v1.0.0
git push origin v1.0.0

# 备份数据
./scripts/backup.sh
```

#### 2. 拉取新版本
```bash
git pull origin main
```

#### 3. 更新依赖
```bash
cd backend
npm install

cd ../frontend
npm install
```

#### 4. 运行迁移脚本（如有）
```bash
npm run migrate
```

#### 5. 重启服务
```bash
pm2 restart exam-analysis
```

#### 6. 验证功能
```bash
# 运行测试
npm test

# 手动测试关键功能
```

---

## 📈 性能优化

### 1. 启用缓存
```bash
# 增加缓存时间
export IMAGE_ANALYZE_CACHE_TTL_MS=1209600000  # 14天

# 监控缓存命中率
# 目标: ≥30%
```

### 2. 优化并发
```bash
# 根据CPU核心数调整
export MAX_CONCURRENT_JOBS=4  # 四核CPU

# 监控CPU使用率
# 目标: 60-80%
```

### 3. 使用CDN
```bash
# 将静态资源部署到CDN
# 减少服务器负载
```

### 4. 数据库优化（如使用）
```bash
# 添加索引
# 定期清理过期数据
# 使用连接池
```

---

## 🚨 应急预案

### 服务中断

**步骤**:
1. 检查服务状态: `pm2 status`
2. 查看错误日志: `pm2 logs exam-analysis --err`
3. 尝试重启: `pm2 restart exam-analysis`
4. 如果无法恢复，回滚到上一个稳定版本

### API配额耗尽

**步骤**:
1. 切换到备用提供商: `export DEFAULT_PROVIDER=aliyun`
2. 重启服务: `pm2 restart exam-analysis`
3. 联系提供商增加配额
4. 考虑实施速率限制

### 数据丢失

**步骤**:
1. 停止服务
2. 从最近的备份恢复数据
3. 验证数据完整性
4. 重启服务
5. 通知用户（如需要）

---

## 📞 技术支持

### 联系方式
- **开发团队**: 查看项目文档
- **紧急联系**: 查看团队通讯录

### 相关文档
- `质量优化项目完成报告.md` - 项目总结
- `API文档_新增功能.md` - API文档
- `前端开发任务清单.md` - 前端任务

---

## ✅ 部署检查清单

### 部署前
- [ ] 环境变量已配置
- [ ] API Key已验证
- [ ] 依赖已安装
- [ ] 配置文件已备份
- [ ] 测试已通过

### 部署后
- [ ] 服务正常启动
- [ ] 健康检查通过
- [ ] 日志正常输出
- [ ] 关键功能可用
- [ ] 性能指标正常

### 运维检查（每周）
- [ ] 检查日志错误
- [ ] 监控性能指标
- [ ] 备份数据
- [ ] 检查磁盘空间
- [ ] 更新依赖（如需要）

---

**文档版本**: v2.0  
**最后更新**: 2026年1月12日  
**维护者**: 运维团队
