# 云端服务器日常管理与维护手册（ECS + Nginx + PM2）

**适用环境**: 阿里云 ECS（Ubuntu）  
**项目路径**: `/opt/exam-analysis-helper`  
**服务形态**: 前端静态站点（Nginx） + 后端 Node 服务（PM2）  

---

## 1. 目录与组件

*   **代码目录**: `/opt/exam-analysis-helper`
*   **前端构建产物**: `/opt/exam-analysis-helper/frontend/web/dist`
*   **后端运行产物**: `/opt/exam-analysis-helper/backend/dist/server.js`
*   **反向代理**: Nginx 负责静态站点与 `/api/*` 反代
*   **进程守护**: PM2 守护后端服务（示例应用名：`exam-helper-backend`）

---

## 2. 常用命令速查（最常用）

**查看服务状态**

```bash
pm2 status
systemctl status nginx --no-pager
```

**查看日志**

```bash
pm2 logs exam-helper-backend --lines 100
tail -n 200 /var/log/nginx/error.log
tail -n 200 /var/log/nginx/access.log
```

**健康检查（连通性）**

```bash
curl -I http://127.0.0.1/
curl -sS -o /dev/null -w "%{http_code}\n" http://127.0.0.1:3002/
```

**重启服务**

```bash
pm2 restart exam-helper-backend
nginx -t && systemctl reload nginx
```

---

## 3. 标准发布流程（GitHub -> ECS）

### 3.1 拉取最新代码

```bash
cd /opt/exam-analysis-helper
git pull
```

若提示工作区有改动，优先清理再拉取：

```bash
git status
git restore .
git pull
```

### 3.2 发布后端（PM2）

```bash
cd /opt/exam-analysis-helper/backend
npm ci
npm run build
pm2 restart exam-helper-backend
pm2 status
pm2 logs exam-helper-backend --lines 80
```

### 3.3 发布前端（Nginx）

```bash
cd /opt/exam-analysis-helper/frontend/web
npm ci
npm run build
nginx -t && systemctl reload nginx
```

验证 Nginx root 指向 dist：

```bash
nginx -T | grep -nE "root /opt/exam-analysis-helper/frontend/web/dist;" || true
```

---

## 4. 进程与端口确认

**查看监听端口**

```bash
ss -lntp | grep -E "nginx|node" || true
```

**查看后端进程（PM2 / Node）**

```bash
ps -ef | grep -E "pm2|backend/dist/server\.js" | grep -v grep
```

---

## 5. Nginx 运维要点

### 5.1 常见配置位置

```bash
nginx -T | head -n 80
```

常见目录（以实际输出为准）：

*   `/etc/nginx/nginx.conf`
*   `/etc/nginx/sites-enabled/*`

### 5.2 常见问题与处理

**上传图片报 413（请求体过大）**

*   Nginx 配置增加 `client_max_body_size`（例如 `20m` 或更大），然后 reload：

```bash
nginx -t && systemctl reload nginx
```

**接口反代 502 / 504**

*   先确认后端端口可达：`curl -sS -o /dev/null -w "%{http_code}\n" http://127.0.0.1:3002/`
*   查看 PM2 日志：`pm2 logs exam-helper-backend --lines 120`
*   查看 Nginx error log：`tail -n 200 /var/log/nginx/error.log`

---

## 6. PM2 运维要点

**查看/重启**

```bash
pm2 status
pm2 restart exam-helper-backend
```

**启动项与开机自启**

```bash
pm2 startup
pm2 save
```

若你们已经配置过，以上命令一般无需重复执行；以线上既有约定为准。

---

## 7. 环境变量与密钥管理（安全约定）

*   不把任何 Key 写入仓库。
*   后端进程需要的 Key 以服务器 `.env` 或 systemd/PM2 环境变量方式注入。
*   需要变更密钥时，先更新环境变量，再 `pm2 restart exam-helper-backend --update-env`。
*   建议同时配置分析稳定性相关参数（按需取舍）：
    *   `LLM_TIMEOUT_MS` / `LLM_RETRY_COUNT` / `LLM_RETRY_BASE_DELAY_MS`
    *   `MAX_CONCURRENT_IMAGE_JOBS`
    *   `IMAGE_ANALYZE_CACHE_TTL_MS`
    *   `JOB_TTL_MS` / `JOB_EVENT_BUFFER_SIZE`

---

## 8. 回滚流程（建议 2 分钟内完成）

### 8.1 回滚到上一个提交

```bash
cd /opt/exam-analysis-helper
git log -5 --oneline
git reset --hard <上一版本的commit>
```

### 8.2 重新构建并重启

```bash
cd backend && npm ci && npm run build && pm2 restart exam-helper-backend
cd ../frontend/web && npm ci && npm run build && nginx -t && systemctl reload nginx
```

---

## 9. 日常巡检清单（建议每天 5 分钟）

1.  `pm2 status` 是否在线、重启次数是否异常
2.  `pm2 logs exam-helper-backend --lines 50` 是否有大量错误/401/429/5xx
3.  `curl -I http://127.0.0.1/` 是否 200
4.  `tail -n 50 /var/log/nginx/error.log` 是否有持续报错
